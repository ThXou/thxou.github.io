
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Luis Cardenas ThXou</title>
  <meta name="author" content="Luis Cardenas">

  
  <meta name="description" content="Probablemente los que ya habéis usado Core Data en vuestras aplicaciones, os habréis encontrado con que cada vez que modificas el modelo de datos, al &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ThXou.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Luis Cardenas ThXou" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2267618-8']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner">
	<div class="header-title"><a href="/">Luis Cardenas ThXou</a></div>


	<br><div class="header-subtitle">Ama la sabiduría. Desea el conocimiento</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ThXou.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2013/11/12/migracion-sencilla-de-modelos-en-core-data/">Migración Sencilla De Modelos en Core Data</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-11-12T02:21:29+01:00" pubdate data-updated="true">Nov 12<span>th</span>, 2013</time>
        
         | <a href="/2013/11/12/migracion-sencilla-de-modelos-en-core-data/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Probablemente los que ya habéis usado Core Data en vuestras aplicaciones, os habréis encontrado con que cada vez que modificas el modelo de datos, al volver a instalar la app en el simulador o dispositivo, la aplicación genera una excepción y se cierra. En el entorno de desarrollo, la solución inmediata es borrar la aplicación del simulador o dispositivo y volverla a instalar, no obstante esto no nos sirve de cara a actualizar nuestra app que ya está subida a la App Store, por razones obvias.</p><h2>El problema!</h2><p>Sucede que el sistema de almacenamiento en Core Data solo puede ser abierto por el mismo modelo que se ha usado para crearlo, es por eso que cuando cambias el modelo (añades algún atributo, entidad, etc), el modelo modificado deja de ser igual al modelo que se ha usado para crear el almacenamiento, por lo tanto, son incompatibles y el modelo nuevo resulta no apto para llevar a cabo la tarea.</p><p>La solución es llevar a cabo una migración entre versiones del modelo (la anterior y la modificada). Para hacer esta migración, Core Data usa un<strong> modelo de Mapeo</strong> que le permite saber que cambios tiene que realizar para que el nuevo modelo sea capaz de abrir el almacenamiento como lo hacía el modelo anterior.</p><p>Poniéndonos ya en materia, existen 2 tipos de migración:<strong> la migración automática</strong>, de la que hablaremos ahora, y <strong>la migración manual</strong>. Estas 2 tan solo difieren en una cosa: El modelo de mapeo usado para hacer la migración. Os paso a explicar más detalladamente el tema.</p><h2>Migración automática</h2><p>También se le conoce como migración ligera. Es el camino fácil para realizar la tarea, y consiste en que Core Data es quien provee el modelo de mapeo a usarse en la migración, hace esto intentando deducir los cambios que se han hecho a través de un análisis en los esquemas de los 2 modelos.</p><p>Este tipo de migración requiere que el modelo modificado tan solo haya sufrido sencillos cambios en su estructura. Ahora, que entiende Core Data como &#8220;sencillos cambios&#8221;?. Pues los siguientes:</p><ul><li>Añadir o quitar un atributo.</li><li>Cambiar la propiedad <code>optional</code> de los atributos.</li><li>Asignar un valor por defecto a un atributo.</li><li>Renombrar entidades o atributos usando el campo <em>Renaming ID</em>.</li></ul><p>Para casos más complejos es necesario usar la migración manual, en ese caso te toca a ti proveer el mapeo para la migración, proceso que se complica un poco, así que lo dejaremos para otra entrada.</p><h2>Añadiendo un nuevo modelo</h2><p>Vamos con una aplicación práctica para ver mejor como va el tema. Para esto, he creado un proyecto que usa Core Data con un modelo muy sencillo ya definido y que puedes <a href="http://sl.thxou.com/?https://app.box.com/s/2nuh2hgzxq09qtt49t5b">descargar aquí</a>.</p><p>Ya que para hacer una migración son imprescindibles 2 versiones de un modelo, vamos a crear otro diferente a la que ya tenemos en el proyecto yendo al menú <strong>Editor &gt; Add Model Version</strong>. Dejemos el nombre por defecto por esta vez y luego clic en <em>Finish</em>. Esto nos creará <em>Notes 2.xcdatamodel</em> y una especie de carpeta contenedora llamada <em>Notes.xcdatamodeld</em>, en la cual también verás incluido nuestro modelo por defecto.</p><p style="text-align: center;"><a href="http://www.thxou.com/wp-content/uploads/2013/11/Screen-Shot-2013-11-11-at-20.12.37.png"><img class="aligncenter size-full wp-image-2650" alt="Core Data Migration en ThXou" src="http://www.thxou.com/wp-content/uploads/2013/11/Screen-Shot-2013-11-11-at-20.12.37.png" width="256" height="90" /></a></p><p>Si nos fijamos, uno de los modelos aparece con un check de color verde. Esto quiere decir que es ese el modelo que estamos usando actualmente. Como queremos usar el nuevo modelo a partir de ahora, seleccionamos la carpeta contenedora <em>Notes.xcdatamodeld</em> y en panel<em> File Inspector</em> de la derecha, en el apartado<em> Model Version</em>, cambiamos la opción<em> Current</em> a<em> Notes 2</em>, que es nuestro nuevo modelo.</p><p>Vamos a hacer un par de modificaciones a <em>Notes 2</em>. Selecciona la entidad <strong>Note</strong> y añade un nuevo atributo llamado <strong>descriptionText</strong> de tipo <strong>String</strong>. Ahora vamos a renombrar el atributo <strong>backgroundColor</strong> a solo <strong>background</strong>.</p><p style="text-align: center;"><a href="http://www.thxou.com/wp-content/uploads/2013/11/Screen-Shot-2013-11-11-at-23.58.32.png"><img class="aligncenter  wp-image-2651" alt="Core Data Migration in ThXou" src="http://www.thxou.com/wp-content/uploads/2013/11/Screen-Shot-2013-11-11-at-23.58.32.png" width="526" height="134" /></a></p><p>Vamos a sanear cualquier error que pueda ocurrir después del cambio en el modelo de nuestra aplicación haciendo la migración, pero antes comentarte que al renombrar entidades o atributos es necesario definir el campo <em>Renaming ID</em>. Selecciona el atributo que hemos renombrado: <strong>background</strong>, y en el panel <em>Data Model Inspector</em> de la derecha, escribe en el campo <em>Renaming ID</em>, el nombre anterior del atributo, osea <strong>backgroundColor</strong> (Si no te acuerdas puedes mirar en la primera versión del modelo). Esto es obligatorio para cuando vayas a renombrar entidades o atributos.</p><p><a href="http://www.thxou.com/wp-content/uploads/2013/11/Screen-Shot-2013-11-12-at-00.06.30.png"><img class="aligncenter size-full wp-image-2652" alt="Core Data Migration" src="http://www.thxou.com/wp-content/uploads/2013/11/Screen-Shot-2013-11-12-at-00.06.30.png" width="254" height="83" /></a></p><h2>Haciendo la mudanza</h2><p>Lo que nos queda ahora es decirle a Core Data que haga la migración automática al iniciar la aplicación. Para esto nos tenemos que dirigir al <em>Core Data Stack</em> localizado en el fichero <em>AppDelegate.m</em>. En el vas a encontrar el método getter del Persistent Store Coordinator. Modifícalo con el siguiente código:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSPersistentStoreCoordinator</span> <span class="o">*</span><span class="p">)</span><span class="nf">persistentStoreCoordinator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">_persistentStoreCoordinator</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_persistentStoreCoordinator</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">storeURL</span> <span class="o">=</span> <span class="p">[[</span><span class="n">self</span> <span class="n">applicationDocumentsDirectory</span><span class="p">]</span> <span class="nl">URLByAppendingPathComponent:</span><span class="s">@&quot;Notes.sqlite&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="n">_persistentStoreCoordinator</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSPersistentStoreCoordinator</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithManagedObjectModel:</span><span class="p">[</span><span class="n">self</span> <span class="n">managedObjectModel</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// (2)</span>
</span><span class='line'>    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="nl">NSMigratePersistentStoresAutomaticallyOption:</span><span class="err">@</span><span class="n">YES</span><span class="p">,</span> <span class="nl">NSInferMappingModelAutomaticallyOption:</span><span class="err">@</span><span class="n">YES</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">_persistentStoreCoordinator</span> <span class="nl">addPersistentStoreWithType:</span><span class="n">NSSQLiteStoreType</span> <span class="nl">configuration:</span><span class="nb">nil</span> <span class="nl">URL:</span><span class="n">storeURL</span> <span class="nl">options:</span><span class="n">options</span> <span class="nl">error:</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">error</span><span class="p">])</span> <span class="p">{</span> <span class="c1">// (1)</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Unresolved error %@, %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="n">userInfo</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">abort</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">_persistentStoreCoordinator</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Dentro hay que modificar el método <code>addPersistentStoreWithType:configuration:URL:options:error:</code>(1), que es quien crea el almacenamiento para la app, en concreto el parámetro <code>options:</code>, a quien por defecto se le pasa <code>nil</code>, pero nosotros le asignamos el diccionario <code>options</code> con las keys que van a decirle a Core Data que lleve a cabo la migración automática (2).</p><p>Hasta este punto, ya puedes poner a correr la aplicación que estés migrando, verás que todo marcha sobre ruedas. Si no te salta ningún error ni ocurre ningún problema es porque la migración se ha realizado satisfactoriamente.</p><h2>Como se si mi app puede migrar automáticamente?</h2><p>Esto es un extra, por si se te plantea la pregunta para tus proyectos. Hemos visto que hay 2 formas de hacer la migración: automática (Fácil) y manual (difícil), como saber si mi app puede migrar automáticamente?. La respuesta está en preguntarle a la clase <code>NSMappingModel</code> si es capaz o no de crear el <strong>modelo de mapeo</strong> por si mismo. Esto lo hacemos con el método<code> inferredMappingModelForSourceModel:destinationModel:error:</code>:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">miModeloPuedeMigrar</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">modeloAntiguoURL</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="nl">URLForResource:</span><span class="s">@&quot;Notes&quot;</span> <span class="nl">withExtension:</span><span class="s">@&quot;momd&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSManagedObjectModel</span> <span class="o">*</span><span class="n">modeloAntiguo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSManagedObjectModel</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithContentsOfURL:</span><span class="n">modeloAntiguoURL</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">modeloNuevoURL</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="nl">URLForResource:</span><span class="s">@&quot;Notes 2&quot;</span> <span class="nl">withExtension:</span><span class="s">@&quot;momd&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSManagedObjectModel</span> <span class="o">*</span><span class="n">modeloNuevo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSManagedObjectModel</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithContentsOfURL:</span><span class="n">modeloNuevoURL</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSMappingModel</span> <span class="o">*</span><span class="n">modeloDeMapeo</span> <span class="o">=</span>
</span><span class='line'>        <span class="p">[</span><span class="n">NSMappingModel</span> <span class="nl">inferredMappingModelForSourceModel:</span><span class="n">modeloAntiguo</span>
</span><span class='line'>                        <span class="nl">destinationModel:</span><span class="n">modeloNuevo</span> <span class="nl">error:</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// si Core Data es capaz de crear el modelo entonces </span>
</span><span class='line'>    <span class="c1">// retornamos YES de lo contrario NO</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modeloDeMapeo</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Este método lo puedes usar en el método<code> application:didFinishLaunchingWithOptions:launchOptions</code> del <em>AppDelegate.m</em>, con un <code>NSLog</code> que te devuelva SI o NO dependiendo del valor de retorno del método <code>miModeloPuedeMigrar</code>.</p><h2>Conclución</h2><p>Este tutorial, como dije antes, es para cuando tienes que hacer ciertos cambios de los listados arriba. Si lo tuyo requiere algo diferente te va a tocar optar por aprender a realizar un mapeo personalizado.</p><p>Ten en cuenta cuando renombres entidades, que las clases modelo asociadas no se cambian, por lo que es algo de lo que te tienes que ocupar tu manualmente o usando la herramienta de refactorización de Xcode.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2013/06/25/disponible-la-segunda-beta-de-ios-7-para-desarrolladores/">Disponible La Segunda Beta De iOS 7 Para Desarrolladores</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-06-25T22:41:01+02:00" pubdate data-updated="true">Jun 25<span>th</span>, 2013</time>
        
         | <a href="/2013/06/25/disponible-la-segunda-beta-de-ios-7-para-desarrolladores/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ayer salió la segunda beta de iOS 7 para desarrolladores. Como se esperaba, viene con mejoras en el rendimiento y duración de la batería, así como también en el tema de la fluidez que comentaba en la entrada anterior en animaciones como la de la multitarea.</p><p>También, a diferencia de la beta 1, esta vez se ha lanzado la versión para iPad y iPad Mini, cubriendo así la totalidad de los dispositivos que faltaban y que se sabía eran compatibles con iOS 7.</p><p>Vuelve la aplicación de grabación de notas de voz retirada por Apple en la primera beta. Con la interfaz adaptada para iOS 7 y una nueva organización de las opciones que hacen un poco más fácil que antes el hecho de ver y manipular nuestras grabaciones y su duración.</p><p>Puedes descargarte la beta 2 de iOS 7 desde el la <a href="http://developer.apple.com/ios">web de desarrolladores de Apple</a> y directamente desde el dispositivo si ya tienes instalada la beta 1 a través de OTA entrando en <strong>Ajustes &gt; General &gt; Actualización de Software</strong>.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2013/06/18/un-vistazo-al-nuevo-ios-7/">Un Vistazo Al Nuevo iOS 7</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-06-18T11:42:00+02:00" pubdate data-updated="true">Jun 18<span>th</span>, 2013</time>
        
         | <a href="/2013/06/18/un-vistazo-al-nuevo-ios-7/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>El pasado lunes 10, como ya sabéis, &#8220;tito Tim&#8221; lanzó el nuevo sistema operativo <strong>iOS 7,</strong> junto con un buen puñado de novedades entre la que destaca la completamente renovada interfaz gráfica (ver imagen superior) y un conjunto de nuevas funciones que pretenden hacernos la vida más fácil a los usuarios.</p><p>Hubiera escrito antes este resumen, pero he preferido pasar unos días trasteando con la primera beta para ver que tal y poder dar una opinión más consistente sobre el nuevo OS. Así que sin mayor dilación paso a describir algunos aspectos.</p><h2>La &#8220;fluidez&#8221; del SO y la suerte de ser la beta 1</h2><p>Si hay algo que tienen las betas es que puedes mostrar al público un trasto inútil y quedarte tan ancho mientras recibes feedback. Yo soy de los que me comí las 2 horas de Keynote y también vi cuan fluido iba todo en el iPhone de pruebas, mientras mostraban el Safari, el scrolling, acceso a multitarea, etc etc., pues definitivamente ellos no tenían instalada la misma beta que el mortal desarrollador de apps se puede descargar. Hay cocas no tan fluidas como me esperaba, como el hecho de abrir y cerrar la multitarea o las carpetas, que son cosas básicas y deberían de ir bien sobre todo ejecutadas en un iPhone 5, pero bueno, por suerte es una primera beta y yo supongo que los de Apple ya habrán tomado nota de fallos como estos.</p><p>Lo que si hay que rescatar es la notable mejora en el encendido del dispositivo, el SO carga muy rápido en comparación con sus predecesores.</p><h2>La pantalla de bloqueo</h2><p>Empecemos por el principio, con una de las cosas que me gusta del nuevo iOS. Botón de cámara mostrado sutilmente, fecha y hora con un trazo fino y el &#8221;<em>slide to unlock</em>&#8221; que para mi no necesitaba una caja contenedora sino solo lo que muestra el nuevo iOS, dejan ver claramente el fondo de pantalla que para mi es importante.</p><p><a href="http://www.thxou.com/wp-content/uploads/2013/06/screen-lock.png"><img class="aligncenter size-medium wp-image-2581" alt="iOS 7 Screen lock en el Blog de ThXou" src="http://www.thxou.com/wp-content/uploads/2013/06/screen-lock-171x300.png" width="171" height="300" /></a></p><p>Lo que son las notificaciones también me molan, a pesar de que abarcan más espacio que antes, me gustan más que las anteriores. De igual forma la pantalla de bloqueo con código, también me parece acertada, sobre todo ese efecto de dejar ver trozos del fondo de pantalla al pulsar los números, me agrada.</p><h2>Control Center</h2><p>A mi, que he tenido Jailbreak, me parece una imitación mediocre de SBSettings. Como podéis ver en la imagen de arriba, posee accesos directos NO personalizables a ciertas funciones del sistema, como: activar/desactivar el modo avión, el Wifi, Bluetooth, Do Not Disturb, etc., yo me pregunto, donde está el de activar/desactivar el 3G y la localización?, costaba tanto poner un ScrollView con más de las funciones importantes?.</p><p>Yendo al final hay otra línea NO personalizable de accesos directos a aplicaciones. A ver, lo de la linterna está genial, pero y la calculadora que la uso una vez por semana para calcular en cuanto hay que dividir la paga del campo de futbol sala?, porque no poner un área para elegir los iconos que quiero poner?. Esperemos que elegir sea una opción en la beta 2, la 3 o la versión final, seguro que más de uno estará de acuerdo conmigo.</p><p>Alguna cosa más que me causa rechazo es que se me abra el Control Center al momento de presionar el botón &#8220;123&#8221; del teclado y luego arrastrar para elegir algo de la segunda pantalla. Me irrita un poco eso, por lo demás, el diseño también me gusta.</p><h2>Notification Center</h2><p>Como dije antes, el nuevo estilo de las notificaciones aunque sea más grande, me gusta. Hay cosas que aún faltan por pulir como que el calendario del Notification Center no me muestra las cosas del día por lo menos hasta que no quedan un par de horas para que se cumplan o el fallo de distribución de las pestañas en modo landscape, por lo demás satisface mis gustos.</p><h2>Nuevos iconos de gominola</h2><p>Aunque es muy cierto que apostar por lo simple es siempre un acierto para mi, se puede uno exceder en simpleza hasta limites &#8220;Tim Cookeanos&#8221;. A veces al desbloquear mi iPhone con iOS 7 me siento como entrando en una tienda de chuches, sobre todo al ver el icono de Game Center (desterrado por fuerza mayor a una pantalla poco concurrida).</p><p><a href="http://www.thxou.com/wp-content/uploads/2013/06/Screen-Shot-2013-06-18-at-01.08.26.png"><img class="aligncenter size-medium wp-image-2587" alt="Iconos de iOS 7 en el Blog de ThXou" src="http://www.thxou.com/wp-content/uploads/2013/06/Screen-Shot-2013-06-18-at-01.08.26-300x166.png" width="300" height="166" /></a></p><p>Bromas a parte, me gusta la apuesta de Apple por la simpleza, no obstante no me termina de enganchar del todo ya que los nuevos iconos hacen que tenga nostalgia por los anteriores :&#8217;c. Pienso que podían habérselo currado más con algunos como el de Game Center, Cámara, Recordatorios, el de bolsa -que parece que hubieran activado la opción &#8220;Invertir Colores&#8221; de la accesibilidad y hubieran hecho una captura de pantalla-, hacen que sienta un poco como que me han querido &#8220;vender la moto&#8221;, aunque de hecho, ya me la han vendido!.</p><p>Pese a todo esto, no está del todo mal, es mejorable pero no está mal, por suerte aún queda trozo para la release final y a ver si nos sorprenden, que por lo que leo por ahí, están retocando los iconos. Ya veremos.</p><h2>iTunes Radio</h2><p>Es un nuevo servicio de música vía streaming que se integra en la aplicación de iTunes, el cual pretende ser directo competidor de servicios geniales como Spotify o pandora. Su punto fuerte es que tiene un sistema inteligente que te ofrece música para escuchar basada en tu historial, tus gustos, artistas preferidos; en sí todo lo que sueles escuchar, útil si eres de los que como yo van buscando nueva música para oír. Podrás elegir entre 200 estaciones, compartir las canciones con amigos, etc.</p><p><a href="http://www.thxou.com/wp-content/uploads/2013/06/iTunes-radio.png"><img class="aligncenter size-medium wp-image-2578" alt="iTunes Radio en el Blog de ThXou" src="http://www.thxou.com/wp-content/uploads/2013/06/iTunes-radio-171x300.png" width="171" height="300" /></a></p><p>Dicen que es gratis, yo de momento no dejo de ver precios en las imágenes de la <a href="http://www.apple.com/itunes/itunes-radio/">Web oficial</a>, ya veremos que nos trae. Solo estará disponible en Estados Unidos por el momento, pero como paso con iTunes Match, se espera que vaya aumentando su presencia en varios países con el tiempo.</p><h2>Multitarea androide</h2><p>Saltaba rebosante de felicidad por la nueva multitarea hasta que un compañero con un Android 4 me mostró lo que parece ser &#8220;el original&#8221;. Yo que quieres que te diga, se parecen mucho, obviamente se ve mejor en el iPhone, pero me parece que alguien se ha querido copiar, no diré quien ¬¬.</p><p style="text-align: center;"><a href="http://www.thxou.com/wp-content/uploads/2013/06/multitarea.png"><img alt="Multitarea de iOS 7 en el Blog de ThXou" src="http://www.thxou.com/wp-content/uploads/2013/06/multitarea-170x300.png" width="170" height="300" /></a></p><p>A pesar de la decepción, me gusta también. Creo que tienen que permitir que se cierre la multitarea al presionar fuera de las aplicaciones (en el fondo de pantalla quiero decir) y que la animación sea más fluida, y lo que sería un puntazo es ver un botón para cerrarlas todas de golpe, aunque igual se lo están reservando para iOS 20, quien sabe.</p><p>Lo otro es que chupa muchísima batería. Supongo que será por que ahora TODAS las aplicaciones se mantienen en segundo plano y no se cierran, y por consiguiente el procesador tiene trabajito extra y pues, de algo se tiene que alimentar. La solución rápida a este problema es ir cerrando las aplicaciones que no vayamos a utilizar. De nada.</p><h2>Cámara</h2><p>Para mi es una de las aplicaciones que más ha cambiado para bien (excepto el icono). Por lo menos en mi iPhone, el enfoque y las fotos se hacen más rápido, y la nueva utilidad de aplicar filtros a las fotos, antes y/o después de tomarlas, con la opción de descartar los cambios, es un puntazo. Se carga algunas aplicaciones que tengo de filtros y tal, pero bueno, espacio que me ahorro.</p><p><a href="http://www.thxou.com/wp-content/uploads/2013/06/camara.png"><img class="aligncenter size-medium wp-image-2591" alt="Cámara en iOS 7 en el Blog de ThXou" src="http://www.thxou.com/wp-content/uploads/2013/06/camara-171x300.png" width="171" height="300" /></a></p><p>Esa característica de arrastrar para cambiar el modo me parece muy acertada, no le veía el porque a tener que buscar el botón de panorama en vez de simplemente ver la opción y hacer la foto. También se ha añadido un nuevo tipo de toma cuadrada.</p><h2>Fotos</h2><p>Las novedades de la aplicación de fotos se centran en agrupar las fotografías. En principio se agrupan por años. De una sola vez puedes ver todas (literalmente) las fotos que has hecho cada año. Cada año está compuesto por colecciones que están organizadas por rangos de fechas o nombres de eventos, todo esto es organizado automáticamente. La pestaña de álbumes organiza un poco el carrete y crea un nuevo álbum para los vídeos y las fotografías en panorama.</p><p><img class="aligncenter size-medium wp-image-2589" alt="Fotos en el Blog de ThXou" src="http://www.thxou.com/wp-content/uploads/2013/06/Screen-Shot-2013-06-18-at-01.42.36-170x300.png" width="170" height="300" /></p><p>La pestaña &#8220;Shared&#8221; te permite crear un Stream, el cual no es más que una forma de compartir tus fotografías y vídeos de forma privada a través de iCloud con las personas que desees. No he podido probar del todo esta característica debido a que al añadir lo que sea, sale un mensaje de alerta que dice que estará disponible muy pronto. Es una beta, no hay que perder los nervios aún.</p><h2>AirDrop</h2><p>Compartir por Bluetooth. Una característica que se pedía desde que salió el iPhone allá en 2007, ya es una realidad en el 2013, SOLO 6 años después, que maravilla!. Puedes compartir fotos, vídeo, pases, contactos y mús&#8230;Oh wait!, música no.</p><p>No solo usa el Bluetooth sino también puede usar la red Wi-Fi para enviar los datos, y lo hace todo encriptado para mayor seguridad. También puedes ponerte en estado visible o invisible según creas conveniente. Puedes acceder a AirDrop desde cualquier parte del dispositivo, inclusive desde cualquier aplicación, esto es debido a que está permanentemente integrado en el Control Center.</p><p>Como programador de iOS le veo utilidad para compartir datos entre dispositivos desde mi aplicación, como usuario creo que la usaré la misma cantidad de veces que la voy usando desde hace 4 años, cero.</p><h2>Safari</h2><p>Safari es otra de las aplicaciones que ha cambiado para bien. Ahora es más a pantalla completa, los botones y las barras se ocultan hasta que hagas scroll. Las páginas abiertas se muestran diferente, como en 3D y con una animación muy chula, para mi gusto está genial.</p><p><a href="http://www.thxou.com/wp-content/uploads/2013/06/safari.png"><img class="aligncenter size-medium wp-image-2592" alt="Safari en iOS7 en el Blog de ThXou" src="http://www.thxou.com/wp-content/uploads/2013/06/safari-170x300.png" width="170" height="300" /></a></p><p>Incorpora una utilidad nueva llamada <strong>iCloud Keychain</strong>, la cual nos permite almacenar nuestras contraseñas, cuentas de usuario y hasta tarjetas de crédito, en iCloud. Luego Safari recoge estos datos y los muestra automáticamente (según tus preferencias, claro) cuando entras a algún sitio que las requiere. Puede parecer poco seguro pero no lo es, toda esta transmisión de datos confidenciales se hace con una encriptación AES de 256-bits.</p><p>En cuanto a la fluidez al hacer scroll que nos mostraban en la Keynote, aún no veo mucho el cambio la verdad, no he notado nada.</p><h2>Otras novedades</h2><p>[one_half]La <strong>App Store</strong> ha incorporado actualizaciones automáticas de las aplicaciones cuando estás conectado a una red Wi-Fi. Bien visto para mi. Luego también hay un nuevo apartado que nos muestra aplicaciones cercanas a nuestra posición actual. A mi no me ha funcionado por el momento.[/one_half]</p><p>[one_half_last]<strong>Siri</strong> ha aprendido nuevas cosas y ahora se integra con servicios como Twitter, iTunes Radio, Wikipedia o Bing. Posee una interfaz completamente re diseñada y su voz es un poco más humana que antes, vamos! que se entiende mejor.[/one_half_last]</p><h2>Conclusión</h2><p>Es la primera beta, y como tal se puede permitir algunos fallos como los de rendimiento, cuelgues, fluidez y algunos bugs que hacen que las aplicaciones nativas se cierren inesperadamente. Con respecto a la interfaz de usuario, poco puede cambiar de cara a la versión final, lo mejor va a ser empezar a acostumbrarse cuanto antes a lo nuevo.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2013/03/18/literales-en-objective-c/">Literales en Objective-C</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-03-18T19:04:13+01:00" pubdate data-updated="true">Mar 18<span>th</span>, 2013</time>
        
         | <a href="/2013/03/18/literales-en-objective-c/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Los literales son simplemente unos valores que los programadores podemos escribir &#8220;tal cual&#8221; en el código. En Objective-C (y por lo tanto en C) ya conocemos algunos ejemplos de esto con los valores primitivos:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="kt">float</span> <span class="n">altura</span> <span class="o">=</span> <span class="mf">23.5</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">piezas</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Estos son: un literal float y un literal int respectivamente. Estos literales son comunes en la mayoría de los lenguajes, no obstante Objective-C tiene sus propios literales a parte de los mencionados, concretamente los que están basados en objetos:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSString</span> <span class="o">*</span><span class="n">tarea</span> <span class="o">=</span> <span class="err">@”</span><span class="n">Buscar</span> <span class="n">piso</span><span class="err">”</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Claro, a simple vista podemos decir: Vaya chorrada, lo he usado mil veces!, pero detente un momento a pensar en el ahorro que implica en líneas de código el hecho de tenerlos: como escribirías un número &#8220;sin números&#8221;?, algo aún más terrorífico, plantearse escribir un string de miles de caracteres &#8220;sin strings&#8221;.</p><p>Dicho esto, es fácil darse cuenta de que los literales son una pieza fundamental de cualquier lenguaje por lo que nos ahorran, a parte de por los casos vistos, por la legibilidad en el código, así que vamos a conocer unos cuantos más pero específicos de Objective-C.</p><h2>La nueva moda en literales</h2><p>Hasta la salida de la versión 4.0 del compilador LLVM de Apple, Objective-C aún estaba un poco en pañales con respecto a lo que se refiere a literales. Mientras lenguajes basados en C como Perl o Python ya habían incluido literales para colecciones y más, Objective-C se resistía. Ahora eso ya es parte del pasado y vamos a ver cuales son las novedades en literales.</p><h3>Literales para colecciones</h3><h4>NSArray</h4><p>Clang, el front end de LLVM, introdujo la sintaxis <code>@[ ]</code> para definir arrays, en el cual solo se deben incluir objetos separados por comas. Ojo!, solo objetos, nada de tipos escalares. Así, lo que antes escribíamos así:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSArray</span> <span class="o">*</span><span class="n">ciudades</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSArray</span> <span class="nl">arrayWithObjects:</span><span class="s">@&quot;Barcelona&quot;</span><span class="p">,</span> <span class="s">@&quot;Lima&quot;</span><span class="p">,</span> <span class="s">@&quot;Lyon&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Ahora nos queda así:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSArray</span> <span class="o">*</span><span class="n">ciudades</span> <span class="o">=</span> <span class="err">@</span><span class="p">[</span><span class="err">@”</span><span class="n">Barcelona</span><span class="err">”</span><span class="p">,</span> <span class="err">@”</span><span class="n">Lima</span><span class="err">”</span><span class="p">,</span> <span class="err">@”</span><span class="n">Lyon</span><span class="err">”</span><span class="p">];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Al ser una característica del lenguaje ya no es necesario definir el centinela nil, de hecho si lo pones como valor, tu ordenador explotará, ya que se realiza una validación como para el método <code>[NSArrayarrayWithObjects:count:]</code>, en el que se requiere que ningún objeto sea nil. Por lo tanto si quieres pasar nil como valor tendrás que hacerlo con el objeto <code>[NSNull null]</code>, que es su equivalente.</p><h4>NSDictionary</h4><p>Aquí se introduce la sintaxis <code>@{ }</code>, similar a la de JSON o Javascript, pero con el @ característico de Objective-C. Esta sintaxis crea un diccionario de pares key-value, donde key tiene que ser un objeto que implemente el protocolo NSCopying (los string de toda la vida, vamos!) y value, como en el caso anterior, sólo pueden ser punteros a objetos Objective-C. Algo como:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">usuario</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDictionary</span> <span class="nl">dictionaryWithObjectsAndKeys:</span><span class="err">@”</span><span class="n">ThXou</span><span class="err">”</span><span class="p">,</span> <span class="err">@”</span><span class="n">nombre</span><span class="err">”</span><span class="p">,</span> <span class="err">@”</span><span class="n">Barcelona</span><span class="err">”</span><span class="p">,</span> <span class="err">@”</span><span class="n">ubicacion</span><span class="err">”</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Ahora se escribiría:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">usuario</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="err">@”</span><span class="n">nombre</span><span class="err">”</span> <span class="o">:</span> <span class="err">@”</span><span class="n">ThXou</span><span class="err">”</span><span class="p">,</span> <span class="err">@”</span><span class="n">ubicacion</span><span class="err">”</span> <span class="o">:</span> <span class="err">@”</span><span class="n">Barcelona</span><span class="err">”</span><span class="p">};</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Como en el caso de los arrays, aquí tampoco es necesaria la centinela nil.</p><h4>NSSet</h4><p>Pobre, se olvidaron de él. No se ha introducido nada para esta colección, no obstante con los literales de NSArray se puede aprovechar mucho para NSSet cuando necesitamos pasarlos como argumentos de los métodos inicializadores y métodos de conveniencia.</p><h2>Literales de NSNumber</h2><p>Para los que no sabéis cómo definir NSNumber, pues es una clase que nos permite envolver valores escalares (otros literales de tipo <code>int</code>, <code>bool</code>, <code>float</code>, etc) en objetos Objective-C.</p><p>Ahora, cualquier valor escalar que empiece por el símbolo ‘@’ devolverá un objeto NSNumber inicializado con ese valor. Esto ya lo veíamos con los strings de C. Cuando escribíamos algo como:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSString</span> <span class="o">*</span><span class="n">queja</span> <span class="o">=</span> <span class="s">@&quot;El billete de metro está caro&quot;</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>En realidad estamos convirtiendo un string en C a un objeto NSString con codificación UTF-8. Este literal está desde los inicios, pero para los otros valores escalares usábamos el método <code>numberWith<em>Tipo</em>:</code> para inicializar los objetos NSNumber. Ahora haremos:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="n">bool</span> <span class="o">=</span> <span class="err">@</span><span class="n">NO</span><span class="p">;</span> <span class="c1">// es equivalente a [NSNumber numberWithBool:NO]</span>
</span><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="kt">char</span> <span class="o">=</span> <span class="sc">@&#39;d&#39;</span><span class="p">;</span> <span class="c1">// es equivalente a [NSNumber numberWithChar:’d’]</span>
</span><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="n">unsignedInt</span> <span class="o">=</span> <span class="err">@</span><span class="mi">23</span><span class="n">U</span><span class="p">;</span> <span class="c1">// es equivalente a [NSNumber numberWithUnsignedInt:23U]</span>
</span><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="kt">int</span> <span class="o">=</span> <span class="err">@</span><span class="mi">23</span><span class="p">;</span> <span class="c1">// es equivalente a [NSNumber numberWithInt:23]</span>
</span><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="kt">long</span> <span class="o">=</span> <span class="err">@</span><span class="mi">23L</span><span class="p">;</span> <span class="c1">// es equivalente a [NSNumber numberWithLong:23L]</span>
</span><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="n">longlong</span> <span class="o">=</span> <span class="err">@</span><span class="mi">23L</span><span class="n">L</span><span class="p">;</span> <span class="c1">// es equivalente a [NSNumber numberWithLongLong:23LL]</span>
</span><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="kt">float</span> <span class="o">=</span> <span class="err">@</span><span class="mf">5.2303F</span><span class="p">;</span> <span class="c1">// es equivalente a [NSNumber numberWithFloat:5.2303F]</span>
</span><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="kt">double</span> <span class="o">=</span> <span class="err">@</span><span class="mf">2.2808</span><span class="p">;</span> <span class="c1">// es equivalente a [NSNumber numberWithDouble:2.2808]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Me encanta este literal, por lo menos a mi me ayuda haciendo más legible el código, sobre todo cuando tengo que hacer una lectura rápida.</p><h2>Expresiones “en caja” (Boxed Expressions)</h2><p>Si la intuición os ha llevado a pensar: ¿Y qué pasa si hago <code>@2+2</code>, el compilador me lo pillará sin enfadarse?. Pues no, ya que hay una nueva sintaxis para esto y es envolver nuestras expresiones entre paréntesis: <code>@()</code>. Esto nos devolvería un objeto NSNumber inicializado con el resultado de la expresión que está entre estos. Y lo que antes hacíamos así:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="n">piMedios</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSNumber</span> <span class="nl">numberWithDouble:</span><span class="n">M_PI</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Ahora lo hacemos así:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="n">piMedios</span> <span class="o">=</span> <span class="err">@</span><span class="p">(</span><span class="n">M_PI</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Mucho más claro y sencillo. Lo genial es que también funciona pasándole propiedades de algunos objetos Objective-C que devuelven valores escalares. Por ejemplo si tenías que guardar en Core Data el valor de un objeto UISwitch, lo hacíamos así:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">tarea</span><span class="p">.</span><span class="n">completado</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSNumber</span> <span class="nl">numberWithBool:</span><span class="n">mySwitch</span><span class="p">.</span><span class="n">on</span><span class="p">];</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Ahora también lo puedes hacer simplemente así:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">tarea</span><span class="p">.</span><span class="n">completado</span> <span class="o">=</span> <span class="err">@</span><span class="p">(</span><span class="n">mySwitch</span><span class="p">.</span><span class="n">on</span><span class="p">);</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>También funciona para enumeraciones:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span> <span class="n">Barcelona</span><span class="p">,</span> <span class="n">Lima</span><span class="p">,</span> <span class="n">Lyon</span> <span class="p">}</span> <span class="n">Ciudad</span><span class="p">;</span>
</span><span class='line'><span class="n">NSNumber</span> <span class="o">*</span><span class="n">ciudad</span> <span class="o">=</span> <span class="err">@</span><span class="p">(</span><span class="n">Lyon</span><span class="p">);</span> <span class="c1">// nos devolverá 1 y es equivalente a [NSNumber numberWithInt:((int)Lyon)]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>En este caso, para poder usar algún valor de la enumeración tenemos que envolverlo también como si se tratara de una expresión para poder usarlo como literal.</p><h2>Subíndices de objeto (Object Subscripting)</h2><p>Esta última tanda de literales de la que vamos a hablar suple una necesidad en mi que vengo deseando ver desde que dejé C++ para embarcarme en Objective-C, y tiene que ver con la forma de acceder y obtener datos de colecciones, concretamente de arrays y diccionarios.</p><h3>Subíndices para Arrays</h3><p>Para los arrays podemos usar un index para referirnos a la posición de un objeto dentro de ese array, tal como se hacía en C con valores escalares:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSArray</span> <span class="o">*</span><span class="n">ciudades</span> <span class="o">=</span> <span class="err">@</span><span class="p">[</span><span class="s">@&quot;Barcelona&quot;</span><span class="p">,</span> <span class="s">@&quot;Lima&quot;</span><span class="p">,</span> <span class="s">@&quot;Lyon&quot;</span><span class="p">];</span>
</span><span class='line'><span class="n">NSString</span> <span class="o">*</span><span class="n">ciudad</span> <span class="o">=</span> <span class="n">ciudades</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="c1">// ciudad = @&quot;Lyon&quot;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>Aquí se nos devuelve el elemento en la posición 2 que es <code>@"Lyon"</code>. Esto el compilador lo traduce por su equivalente en Objective-C: <code>[ciudades objectAtIndexedSubscript:2]</code>, lo cual es exactamente lo mismo que hacer: <code>[ciudades objectAtIndex:2]</code>.</p><p>De la misma forma, si tenemos un array mutable, entonces podemos hacer asignación directa de valores con esta misma sintaxis:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">ciudades</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">@&quot;Roma&quot;</span><span class="p">;</span> <span class="c1">// el array quedaría: @[@&quot;Barcelona&quot;, @&quot;Roma&quot;, @&quot;Lyon&quot;]</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>El valor en la posición 1 es cambiado por el nuevo. Aquí el compilador hace una traducción al método <code>[ciudades setObject:@"Roma" atIndexedSubscript:1]</code></p><h3>Subíndices para diccionarios</h3><p>Para los diccionarios en vez de usar un index usamos keys para obtener los valores:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">usuario</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;nombre&quot;</span> <span class="o">:</span> <span class="s">@&quot;ThXou&quot;</span><span class="p">,</span> <span class="s">@&quot;ubicacion&quot;</span> <span class="o">:</span> <span class="s">@&quot;Barcelona&quot;</span><span class="p">};</span>
</span><span class='line'><span class="n">NSString</span> <span class="o">*</span><span class="n">ubicacion</span> <span class="o">=</span> <span class="n">usuario</span><span class="p">[</span><span class="s">@&quot;ubicacion&quot;</span><span class="p">];</span> <span class="c1">// ubicacion = @&quot;Barcelona&quot;</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>El compilador hace la traducción a <code>[usuario objectForKeyedSubscript:@"ubicacion"]</code>, el cual es a su vez equivalente a <code>[usuario objectForKey:@"ubicacion"]</code>.</p><p>Como en los arrays, pasa lo mismo para los diccionarios mutables y podemos reemplazar el valor correspondiente a la key que referenciemos:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">usuario</span><span class="p">[</span><span class="s">@&quot;nombre&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">@&quot;ThXou soy yo&quot;</span><span class="p">;</span>
</span><span class='line'><span class="c1">// el diccionario quedaría: @{@&quot;nombre&quot; : @&quot;ThXou soy yo&quot;, @&quot;ubicacion&quot; : @&quot;Barcelona&quot;}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
<p>La traducción correspondiente es <code>[usuario setObject:@"ThXou soy yo" forKeyedSubscript:@"nombre"]</code>.</p><h2>Conclusión</h2><p>Esta nueva sintaxis como se puede observar, ayuda a que nuestro código sea más legible, a la par que nos ahorra tiempo escribiendo sus métodos equivalentes. Va a ser hora de pasarnos a la nueva moda, nunca es tarde aunque ya lleve unos cuantos meses rulando por internet. Es muy importante recordar pasar únicamente objetos al momento de crear objetos usando literales, como también no pasar nunca un <code>nil</code> como un valor.</p><h2>Fuentes:</h2><ul><li><a href="http://clang.llvm.org/docs/ObjectiveCLiterals.html">http://clang.llvm.org/docs/ObjectiveCLiterals.html</a></li><li><a href="http://www.mikeash.com/pyblog/friday-qa-2012-06-22-objective-c-literals.html">http://www.mikeash.com/pyblog/friday-qa-2012-06-22-objective-c-literals.html</a></li></ul></div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2013/02/21/nsnotificationcenter-y-las-notificaciones/">NSNotificationCenter Y Las Notificaciones</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2013-02-21T14:12:51+01:00" pubdate data-updated="true">Feb 21<span>st</span>, 2013</time>
        
         | <a href="/2013/02/21/nsnotificationcenter-y-las-notificaciones/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Vuelvo a la carga con los tutes sobre iOS después de un tiempo ausente por proyectos personales.</p><p>Esta vez os voy a hablar sobre otro tipo de notificaciones, diferentes a las notificaciones locales que <a href="http://www.thxou.com/2012/01/31/programando-notificaciones-locales-con-uilocalnotification/">vimos hace un tiempo</a>. Estas nuevas notificaciones básicamente encapsulan información acerca de algún tipo de evento. Hay objetos que registran estas notificaciones en lo que podemos llamar una &#8220;tabla de notificaciones&#8221;, esta tabla está administrada por un centro de notificaciones, que es un objeto <code>NSNotificationCenter</code>. Luego tenemos objetos que se registran como &#8220;Observadores&#8221; de estas notificaciones, de manera de que cuando una de estas notificaciones es lanzada, todos los observadores &#8220;se enteran&#8221; de esto y normalmente llevan a cabo alguna acción.</p><p>Podría parecer un poco chungo, pero no lo es para nada. Te pongo un ejemplo práctico. Imagina un portal de noticias. Los usuarios entran a este portal y pueden suscribirse a las categorías de noticias que ellos prefieran. Una vez sale una noticia relacionada con categoría a la que el usuario se ha suscrito, entonces le llega un correo electrónico avisándole que hay una nueva noticia, así el usuario puede decidir que hacer en ese momento. Pues bien, si hacemos una comparación sacamos que el usuario que se suscribe a las noticias es el &#8220;Observador&#8221;, el portal de noticias sería el &#8220;centro de notificaciones&#8221; (<code>NSNotificationCenter</code>) y el correo electrónico sería la notificación lanzada por el centro de notificaciones.</p><h2>A tocar código, que es lo que mola</h2><p>Últimamente escribir tanto texto sin una sola línea de código me da alergia, así que vamos a escribir unas cuantas líneas.</p><p>De toda la clase <code>NSNotificationCenter</code>, normalmente solo vamos a usar 4 métodos. El primero es para inicializar nuestro centro de notificaciones. Cada aplicación viene con uno por defecto y para acceder a el usamos un método de clase que lo que hace simplemente es crear un singleton:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSNotificationCenter</span> <span class="o">*</span><span class="n">center</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>
<p>Ya tenemos nuestra instancia en el objeto <code>center</code>. El segundo método nos va a permitir registrar una notificación en el centro de notificaciones. A este método le pasamos el nombre de nuestra notificación y un objeto que es el que envía la notificación, normalmente <code>self</code>:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="n">center</span><span class="err"> </span><span class="nl">postNotificationName:</span><span class="s">@&quot;kTestNotification&quot;</span> <span class="nl">object:</span><span class="n">self</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>
<p>Se podrían separar estas notificaciones en 2 tipos: las personalizadas (como esta) y las que emite el sistema. En las que emite el sistema (por ejemplo cuando el dispositivo es girado o el teclado de un textField es mostrado), no necesitamos usar el método anterior ya que el sistema lo hace solo, nosotros solo tenemos que añadirnos como observadores de esas notificaciones y esperar, así que esto es lo que haremos ahora.</p><h2>Registrándonos como observadores</h2><p>Antes vimos el método para registrar una notificación llamada <code>kTestNotification</code> en el centro de notificaciones. Bien, ahora nos haremos &#8220;Observadores&#8221; de esta notificación para que cuando sea registrada (Osea, cuando sea ejecutado el método anterior), nosotros podamos llevar a cabo alguna acción en ese mismo instante:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="n">center</span> <span class="nl">addObserver:</span><span class="n">self</span>
</span><span class='line'>		   <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">handleNotification:</span><span class="p">)</span>
</span><span class='line'>			   <span class="nl">name:</span><span class="s">@&quot;kTestNotification&quot;</span>
</span><span class='line'>			 <span class="nl">object:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>
<p>El gustillo de este tipo de notificaciones para mi está en que, suponiendo el caso de que tu aplicación tenga 100 controladores, no importa en cual de estos 100 controladores registres la notificación, añadiendo tu clase como observador serás capaz de enterarte cuando sea registrada, en cualquier momento y en cualquier controlador.</p><p>Cuando el centro de notificaciones avisa a los observadores sobre una notificación lo hace de manera síncrona. Esto quiere decir que vas a tener que esperar primero a que todos los observadores reciban sus notificaciones antes de poder hacer algo. Esto se puede solucionar registrando las notificaciones de forma asíncrona usando <code>NSNotificationQueue</code> en vez de <code>NSNotificationCenter</code>, pero esto ya es otro tema del que hablaremos en otra oportunidad.</p><p>Al añadirnos como observadores también definimos un método a ejecutarse cuando la notificación sea registrada:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">handleNotification:</span><span class="p">(</span><span class="n">NSNotification</span><span class="err"> </span><span class="o">*</span><span class="p">)</span><span class="nv">notification</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>	<span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Hey tu!, se ha disparado la notificación!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Aquí simplemente mostramos por consola un texto, pero tu puedes usarlo para lo que quieras, cosas como mostrar un controlador, cerrar una conexión a Internet, etc.</p><h2>Liberando la memoria</h2><p>Lo único que nos queda ahora es liberar la memoria removiendo el observador que hemos asignado antes:</p>
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dealloc</span><span class="err"> </span><span class="p">{</span>
</span><span class='line'>    <span class="c1">// liberamos la memoria que ocupa el observador</span>
</span><span class='line'>    <span class="p">[[</span><span class="n">NSNotificationCenter</span> <span class="n">defaultCenter</span><span class="p">]</span> <span class="nl">removeObserver:</span><span class="n">self</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">super</span><span class="err"> </span><span class="n">dealloc</span><span class="p">];</span> <span class="c1">// quita esta línea si usas ARC</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Como vez, no estamos utilizando el objeto <code>center</code>, y a decir verdad para ahorrarte una innecesaria línea de código te recomiendo no crear un objeto <code>NSNotificationCenter</code>, sino usar la forma: <code>[[NSNotificationCenter defaultCenter] ...</code> , como en el código de arriba.</p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2012/10/25/ios-usant-nsuserdefaults-per-assignar-configuracions-per-defecte/">iOS: Usant NSUserDefaults Per Assignar Configuracions Per Defecte</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2012-10-25T14:06:57+02:00" pubdate data-updated="true">Oct 25<span>th</span>, 2012</time>
        
         | <a href="/2012/10/25/ios-usant-nsuserdefaults-per-assignar-configuracions-per-defecte/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p style="text-align: center;"><a href="http://www.thxou.com/wp-content/uploads/2012/07/photo-1.png"><img title="MyDefaults-thxou.com" src="http://www.thxou.com/wp-content/uploads/2012/07/photo-1-200x300.png" alt="" width="200" height="300" /></a><a href="http://www.thxou.com/wp-content/uploads/2012/07/photo-1.png">
</a></p>
<p style="text-align: left;">Cada aplicació té un sistema d&#8217;emmagatzematge per defecte per a cada usuari anomenat <strong>User Default System</strong> (Des d&#8217;ara UDS), el qual està compost per una base de dades en la qual, a través d&#8217;uns paràmetres i mètodes, podem emmagatzemar i recuperar certs valors, que solen ser petites quantitats de dades que usem comunament en la nostra aplicació. A aquests valors per defecte se&#8217;ls crida: preferències de l&#8217;usuari. Per exemple, podríem voler permetre-li als usuaris triar cuan periòdicament sincronitzar certes dades amb iCloud, aquest valor de temps ho podem emmagatzemar en el UDS i recuperar-ho a l&#8217;inici de l&#8217;aplicació.</p>
Podem classificar les preferències d&#8217;usuari en 2 categories: les que canvien freqüentment i les que no. En aquesta oportunitat treballarem amb les quals canvien freqüentment, l&#8217;altra categoria la veurem en articles posteriors ja que requereix una mica més de profunditat.

La classe <code>NSUserDefaults</code> ens permet interactuar amb el UDS, proveint diversos mètodes per guardar i recuperar dades des d&#8217;aquesta base de dades per defecte.
<h2 dir="ltr">Algunes característiques d&#8217;aquesta classe</h2>
<p dir="ltr">Solament existeix una única instància d&#8217;aquesta classe per aplicació.</p>
Un avantatge és l&#8217;emmagatzematge en caché de la informació. Un sistema com aquest implicaria obrir la base de dades constantment, en concret cada vegada que l&#8217;usuari demani informació. Per evitar aquesta constant obertura, la classe emmagatzema les dades en caché. El mètode <code>synchronize</code> és invocat periòdicament i s&#8217;encarrega d&#8217;escriure les dades noves en caché i d&#8217;actualitzar els ja existents, i això ho fa de forma transparent a l&#8217;usuari. No obstant això si no desitges esperar a la sincronització automàtica, pots usar aquest mètode per actualitzar les dades immediatament, anant amb compte de cridar-ho només quan hagis fet alguna modificació. Així ens evitem una sobrecàrrega de connexions amb la base de dades.

Un altre punt important a tenir en compte és que tots els valors retornats des de la base de dades són immutables (és a dir, que no es poden modificar), fins i tot encara que guardessis un valor mutable (per exemple una instància de <code>NSMutableString</code>), en retornar-ho a l&#8217;usuari seria immutable.
<h2 dir="ltr">Obtenint i escrivint dades</h2>
Explicaré millor el tema amb una mini aplicació que he fet cridada <em>MyDefaults</em>. Aquesta aplicació té certes característiques que mostrar com: l&#8217;hora actual a intervals de temps, un missatge de benvinguda a l&#8217;inici i la data i hora de l&#8217;última vegada que es va obrir l&#8217;aplicació. La primera dada que guardarem serà de tipus <code>float</code> i serà l&#8217;interval en segons en el qual es va a actualitzar l&#8217;hora; el segon és de tipus booleà, ens permetrà definir si volem, o no, mostrar el missatge de benvinguda; el tercer és un string que conté el nostre nom per mostrar-ho en el missatge de benvinguda i en la vista principal; i el quart és de tipus <code>NSDate</code> per a l&#8217;última visita. Podrem personalitzar cadascun d&#8217;aquests valors des d&#8217;una finestra modal cridada: Preferències.

Per interactuar amb les dades de la base de dades, <code>NSUserDefaults</code> posa a la nostra disposició una sèrie de mètodes de conveniència. Ara, quines dades se&#8217;ns permet guardar i obtenir?, concretament els mateixos que en una Property List: <code>NSString</code>, <code>NSNumber</code> (booleans, integers, floats i doubles), <code>NSDate</code>, <code>NSArray</code> o <code>NSDictionary</code>. Per a tipus diferents a aquests podem arxivar-los amb <code>NSData</code>, que també ens permet dades d&#8217;aquest tipus.

Com he dit abans, solament hi ha una instància d&#8217;aquesta classe per aplicació, així que per accedir a ella usem el mètode de classe <code>standardUserDefaults</code>:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>

Ja tenim la nostra instància de la classe, per tant ja podem obtenir i guardar dades. Això ho fem usant els mètodes de conveniència dels quals vaig parlar anteriorment (Al final d&#8217;aquest article hi ha enllaços cap a la documentació per veure la relació sencera de mètodes disponibles). Nosaltres anem a obtenir i a mostrar aquests valors en iniciar el controlador <em>ViewController</em> en el mètode <code>viewDidLoad:</code>:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// obtenim el nom des de la base de dades</span>
</span><span class='line'><span class="n">NSString</span> <span class="o">*</span><span class="n">nombre</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaults</span> <span class="nl">stringForKey:</span><span class="s">@&quot;kMiNombre&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// vam mostrar el missatge de benvinguda amb el nom si el valor de la base de dades ens ho permet</span>
</span><span class='line'><span class="kt">BOOL</span> <span class="n">mostrarMensaje</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaults</span> <span class="nl">boolForKey:</span><span class="s">@&quot;kMostrarMensaje&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">mostrarMensaje</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">UIAlertView</span> <span class="o">*</span><span class="n">mensaje</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIAlertView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithTitle:</span><span class="s">@&quot;MyDefaults&quot;</span>
</span><span class='line'>                                                      <span class="nl">message:</span><span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;Hola %@, bienvenido a MyDefaults&quot;</span><span class="p">,</span> <span class="n">nombre</span><span class="p">]</span>
</span><span class='line'>                                                     <span class="nl">delegate:</span><span class="n">self</span>
</span><span class='line'>                                            <span class="nl">cancelButtonTitle:</span><span class="s">@&quot;Ok&quot;</span>
</span><span class='line'>                                            <span class="nl">otherButtonTitles:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">mensaje</span> <span class="n">show</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">mensaje</span> <span class="n">release</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// obtenim la data de la ultima visita</span>
</span><span class='line'><span class="n">NSDate</span> <span class="o">*</span><span class="n">ultimaVisita</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaults</span> <span class="nl">objectForKey:</span><span class="s">@&quot;kUltimaVisita&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// com a aquesta key li assignem per defecte nil, comprovem que no sigui (osigui que hi hagi alguna data), en cas contrari vam mostrar un missatge alternatiu</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">ultimaVisita</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// formatem la data i hora obtinguda de la base de dades</span>
</span><span class='line'>    <span class="n">NSDateFormatter</span> <span class="o">*</span><span class="n">formatter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSDateFormatter</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">formatter</span> <span class="nl">setDateStyle:</span><span class="n">NSDateFormatterMediumStyle</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">formatter</span> <span class="nl">setTimeStyle:</span><span class="n">NSDateFormatterMediumStyle</span><span class="p">];</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">lblVisita</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">formatter</span> <span class="nl">stringFromDate:</span><span class="n">ultimaVisita</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">formatter</span> <span class="n">release</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">self</span><span class="p">.</span><span class="n">lblVisita</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@&quot;Hola, esta es la primera vez que accedes : )&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// guardem la data de l&#39;última visita</span>
</span><span class='line'><span class="p">[</span><span class="n">defaults</span> <span class="nl">setObject:</span><span class="p">[</span><span class="n">NSDate</span> <span class="n">date</span><span class="p">]</span> <span class="nl">forKey:</span><span class="s">@&quot;kUltimaVisita&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">defaults</span> <span class="n">synchronize</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>

Com poden observar aquests mètodes són molt intuïtius i són de la forma:<strong><em> </em></strong><code><strong><em>tipus</em></strong>ForKey:</code>. On <strong>tipus</strong> és el tipus de dada que vols obtenir, en el nostre cas és <code>float</code>, <code>bool</code>, <code>string</code> i <code>object</code> (pel de tipus <code>NSDate</code>). Les <em>Keys</em>, són simples strings que identifiquen a un valor en concret dins de la base de dades i no poden haver-hi 2 iguals. Jo he usat uns quants objectes <code>UILabel</code> connectats amb el Interface Builder per mostrar aquestes dades d&#8217;una millor manera, com també he usat la classe <code>NSDateFormatter</code> per donar format a la data que ve des de la base de dades en cas que ja s&#8217;hagi guardat alguna abans. Els comentaris en verd t&#8217;ajudaran a entendre millor cada part del codi.

Si van una mica més a baix en el codi veuran que hi ha un mètode anomenat <code>viewWillApperar:</code>, aquest mètode és llançat quan la pantalla és a punt de ser mostrada. En aquest mètode usem un objecte <code>NSTimer</code> per programar l&#8217;actualització de l&#8217;hora a l&#8217;interval de temps que hem obtingut de la base de dades.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Carreguem el valor de l&#39;hora. Usarem un timer per actualitzar l&#39;hora cada x temps</span>
</span><span class='line'><span class="n">NSTimeInterval</span> <span class="n">interval</span> <span class="o">=</span> <span class="p">[</span><span class="n">defaults</span> <span class="nl">floatForKey:</span><span class="s">@&quot;kIntervaloHora&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// posem el timer en funcionament i s&#39;actualitzarà cada &quot;interval&quot; segons</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSTimer</span> <span class="nl">scheduledTimerWithTimeInterval:</span><span class="n">interval</span>
</span><span class='line'>                                              <span class="nl">target:</span><span class="n">self</span>
</span><span class='line'>                                            <span class="nl">selector:</span><span class="k">@selector</span><span class="p">(</span><span class="n">actualizaHora</span><span class="p">)</span>
</span><span class='line'>                                            <span class="nl">userInfo:</span><span class="nb">nil</span>
</span><span class='line'>                                             <span class="nl">repeats:</span><span class="n">YES</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>

Ja tenim les dades mostrades en la UI (Interfície d&#8217;Usuari) per fer tots els canvis que vam crear convenients (Fes-los!) i després guardar-los. Per a això anem al controlador <em>SettingsViewController</em> i aquí trobarem el mètode <code>guardar:</code>, el qual, accionat pel botó <strong>Guardar</strong> de la barra d&#8217;eines, ens guardarà les dades en la *caché per després sincronitzar-los, a través del mètode <code>syncronize</code>, amb la base de dades:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">guardar:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Guardem el *intérvalo d&#39;actualització de l&#39;hora</span>
</span><span class='line'>    <span class="p">[</span><span class="n">defaults</span> <span class="nl">setFloat:</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">txtHora</span><span class="p">.</span><span class="n">text</span> <span class="n">floatValue</span><span class="p">]</span> <span class="nl">forKey:</span><span class="s">@&quot;kIntervaloHora&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Guardem l&#39;estat del UISwitch com un booleà</span>
</span><span class='line'>    <span class="p">[</span><span class="n">defaults</span> <span class="nl">setBool:</span><span class="n">self</span><span class="p">.</span><span class="n">switchMsg</span><span class="p">.</span><span class="n">on</span> <span class="nl">forKey:</span><span class="s">@&quot;kMostrarMensaje&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Guardem el nom que hem definit</span>
</span><span class='line'>    <span class="p">[</span><span class="n">defaults</span> <span class="nl">setObject:</span><span class="n">self</span><span class="p">.</span><span class="n">txtNombre</span><span class="p">.</span><span class="n">text</span> <span class="nl">forKey:</span><span class="s">@&quot;kMiNombre&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// sincronitzem la caché i la base de dades</span>
</span><span class='line'>    <span class="p">[</span><span class="n">defaults</span> <span class="n">synchronize</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="c1">// tanquem la finestra modal</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="nl">dismissModalViewControllerAnimated:</span><span class="n">YES</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Aquí usem novament mètodes de conveniència, els quals tenen la forma: <code>set<em><strong>Tipus</strong></em>:forKey:</code>, on <strong>tipus</strong> pot ser dels tipus escalessis (<code>integer</code>, <code>float</code>, <code>bool</code> o <code>double</code>), <code>NSUrl</code> u <code>object</code> per a qualsevol altre tipus d&#8217;objecte dels esmentats més amunt.

Si ens fixem, també tenim redefinit el mètode <code>viewDidLoad:</code> com va passar en el controlador de la pantalla principal. Fem el mateix, carregar les dades guardades per mostrar-los en la pantalla de preferències.
<h2>Registrant preferències per defecte</h2>
Això seria tot pel que fa a guardar i obtenir dades de la base de dades del <strong>User Default System</strong>. No obstant això he volgut explicar breument com registrar preferències per defecte per a la nostra aplicació. Per exemple si és la primera vegada que l&#8217;executem, probablement ens agradaria que la base de dades ja tingui uns valors emmagatzemats per defecte. Això ho fem en el mètode <code>application:didFinishLaunchingWithOptions:</code> del controlador principal <em>AppDelegate</em>, que és cridat immediatament després d&#8217;acabar de carregar l&#8217;aplicació:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">defaults</span> <span class="nl">boolForKey:</span><span class="s">@&quot;kValoresGuardados&quot;</span><span class="p">])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">defaultValues</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDictionary</span> <span class="nl">dictionaryWithObjectsAndKeys:</span>
</span><span class='line'>                                   <span class="p">[</span><span class="n">NSNumber</span> <span class="nl">numberWithFloat:</span><span class="mf">1.0</span><span class="p">],</span> <span class="s">@&quot;kIntervaloHora&quot;</span><span class="p">,</span>
</span><span class='line'>                                   <span class="p">[</span><span class="n">NSNumber</span> <span class="nl">numberWithBool:</span><span class="n">YES</span><span class="p">],</span> <span class="s">@&quot;kMostrarMensaje&quot;</span><span class="p">,</span>
</span><span class='line'>                                   <span class="s">@&quot;ThXou&quot;</span><span class="p">,</span> <span class="s">@&quot;kMiNombre&quot;</span><span class="p">,</span>
</span><span class='line'>                                   <span class="nb">nil</span><span class="p">,</span> <span class="s">@&quot;kUltimaVisita&quot;</span><span class="p">,</span>
</span><span class='line'>                                   <span class="p">[</span><span class="n">NSNumber</span> <span class="nl">numberWithBool:</span><span class="n">YES</span><span class="p">],</span> <span class="s">@&quot;kValoresGuardados&quot;</span><span class="p">,</span>
</span><span class='line'>                                   <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">defaults</span> <span class="nl">registerDefaults:</span><span class="n">defaultValues</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Al mètode <code>registerDefaults:</code> li passem un diccionari amb els valors i les <em>keys</em> que volem tenir per defecte en la nostra base de dades a l&#8217;inici de l&#8217;aplicació. És important tenir en compte que per als valors de tipus escalar hem d&#8217;usar instàncies de <code>NSNumber</code> com es pot observar en el codi. He afegit una nova <em>key </em>cridada <code>kValoresGuardados</code> per evitar que ens torni a guardar aquests mateixos valors cada vegada que iniciem l&#8217;aplicació i que solament ho faci la primera vegada.
<h2>I ara que?</h2>
Avui hem après a usar la classe <code>NSUserDefaults</code> para a assignar preferències i configuracions per defecte per a la nostra aplicació, així com una sèrie de mètodes per interactuar amb el <strong>User Default System</strong>. Per continuar aprenent sobre aquest tema et recomano que et passis per <a href="http://developer.apple.com/library/ios/#DOCUMENTATION/Cocoa/Reference/Foundation/Classes/NSUserDefaults_Class/Reference/Reference.html">la documentació d&#8217;Apple</a> sobre aquesta classe i facis totes les proves possibles fins que entenguis correctament el seu funcionament.
<p style="text-align: center;"><a href="http://securelink.thxou.com/?https://www.box.com/s/9bfb660d5c26adf2f1c1"><img class="alignnone size-full wp-image-2134" title="boton-thxou.com" src="http://www.thxou.com/wp-content/uploads/2011/11/boton-thxou.png" alt="" width="256" height="52" /></a></p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2012/10/19/ios-aprenent-sobre-delegacio-protocols-i-la-classe-uialertview/">iOS: Aprenent Sobre Delegació, Protocols I La Classe UIAlertView</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2012-10-19T09:39:25+02:00" pubdate data-updated="true">Oct 19<span>th</span>, 2012</time>
        
         | <a href="/2012/10/19/ios-aprenent-sobre-delegacio-protocols-i-la-classe-uialertview/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content">En aquesta ocasió he volgut parlar sobre la delegació, un patró molt comú en Cocoa Touch que a molts principiants se&#8217;ns pot ennuegar, com ha estat el meu cas. És en si un concepte molt senzill d&#8217;entendre, però és clar, depenent de qui t&#8217;ho expliqui. Espero explicar-ho ben perquè tots el puguin entendre, si no és així, digueu-m&#8217;ho en els comentaris.

El concepte delegació en Cocoa Touch es refereix específicament al fet que la teva &#8220;delegues&#8221; a un objecte i ho dotes amb la capacitat de respondre a certs esdeveniments ocorreguts en un altre objecte en particular. Aquest concepte és fàcilment comprensible si ho mires des del punt de vista de la necessitat que hi ha que &#8220;algú&#8221; hagi de rebre i manipular la informació de certs esdeveniments en certs objectes. Un exemple clar ho veiem en el GPS. Com podem saber si el GPS ja va trobar la nostra localització?, la informació retornada pel GPS està allí, però algú ha de rebre-la i treballar amb ella per poder mostrar aquesta localització. Doncs, aquest algú és el delegat. El procés de delegació es fa a través de la propietat <code>delegate</code>. Aquesta propietat no és comuna en totes les classes, solament algunes com <code>UIAccelerometer</code>, <code>UIActionSheet</code>, <code>CLLocationManager</code>, etc. la tenen ja que emeten missatges per als seus esdeveniments. Llavors, assignem a la propietat <code>delegate</code> d&#8217;un objecte la classe que volem que sigui l&#8217;encarregada de manipular els esdeveniments d&#8217;aquest objecte i llest, el delegat ja està preparat per rebre&#8217;ls i manipular-los.

Els esdeveniments estan representats en codi a través de funcions (Mètodes) les quals són cridades cada vegada que l&#8217;esdeveniment ocorre. L&#8217;objecte delegat s&#8217;encarrega d&#8217;implementar aquestes funcions per a la quantitat d&#8217;esdeveniments que s&#8217;envien depenent de cada objecte. Cada objecte delegat solament pot rebre missatges per a esdeveniments d&#8217;un sol objecte en particular, i aquests poden ser més d&#8217;un.
<h2>Aplicació pràctica</h2>
Ben. Seguint amb la meva idea que tot s&#8217;aprèn millor si ho portem a la pràctica, he desenvolupat una petita aplicació que utilitza la classe <code>UIAlertView</code> per mostrar una finestra com la qual vam veure en <a href="http://www.thxou.com/2012/01/31/programando-notificaciones-locales-con-uilocalnotification/">l&#8217;entrada anterior sobre notificacions locals</a>. Aquesta finestra té uns botons, en pressionar-los s&#8217;altera el text que hi ha en una etiqueta (<code>UILabel</code>) que està en la vista principal. Així de senzill.

La classe <code>UIAlertView</code> ens permet representar una finestra d&#8217;alerta en una vista en concret i ho fem així:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="n">UIAlertView</span> <span class="o">*</span><span class="n">ventana</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIAlertView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithTitle:</span><span class="s">@&quot;Mi Ventana&quot;</span>
</span><span class='line'>                                                      <span class="nl">message:</span><span class="s">@&quot;Aprendiendo sobre delegación en thxou.com&quot;</span>
</span><span class='line'>                                                     <span class="nl">delegate:</span><span class="n">self</span>
</span><span class='line'>                                            <span class="nl">cancelButtonTitle:</span><span class="s">@&quot;Cancelar&quot;</span>
</span><span class='line'>                                            <span class="nl">otherButtonTitles:</span><span class="s">@&quot;Limpiar Etiqueta!&quot;</span><span class="p">,</span> <span class="s">@&quot;Opción 1&quot;</span><span class="p">,</span> <span class="s">@&quot;Opción 2&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>

El mètode <code>initWithTitle:message:delegate:cancelButtonTitle:otherButtonTitles</code> s&#8217;encarrega de crear l&#8217;objecte anomenat <code>ventana</code>, que és una instància de <code>UIAlertView</code>, amb una informació per defecte. Doncs bé, finestra té botons i en pressionar-los s&#8217;envia el missatge <code>alertView:clickedButtonAtIndex:</code>.Quan aquest missatge és enviat s&#8217;executa el comportament per defecte que és simplement tancar la finestra d&#8217;alerta.

Anem a fixar-nos en l&#8217;etiqueta <code>delegate:</code> del mètode en el codi d&#8217;a dalt. Sabem que prémer un botó en la finestra és un esdeveniment que dispara el missatge<code> alertView:clickedButtonAtIndex:</code>. Bé, en assignar <code>self</code> a l&#8217;etiqueta <code>delegate:</code>, li estem dient a finestra com va a ser l&#8217;encarregat de gestionar els seus esdeveniments, en el nostre cas (I com veureu en la majoria dels casos) és <code>self</code>, la nostra mateixa classe <em>ViewController</em>.

Veurem que en la majoria dels casos el delegat és assignat d&#8217;aquesta manera:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="n">objeto</span> <span class="nl">setDelegate:</span><span class="n">self</span><span class="p">];</span>
</span><span class='line'><span class="c1">//O también</span>
</span><span class='line'><span class="n">objeto</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>

Aquest codi compleix la mateixa funció que en el nostre exemple.

Ja que no volem que en pressionar els botons s&#8217;executi el comportament per defecte, la nostra classe <code>ViewController</code> necessita implementar aquest mètode disparat per l&#8217;esdeveniment i així li diem a finestra que fer quan es pressioni un botó.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">alertView:</span><span class="p">(</span><span class="n">UIAlertView</span> <span class="o">*</span><span class="p">)</span><span class="nv">alertView</span> <span class="nf">clickedButtonAtIndex:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">buttonIndex</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">switch</span> <span class="p">(</span><span class="n">buttonIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span><span class='line'>            <span class="n">self</span><span class="p">.</span><span class="n">mensaje</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span><span class='line'>            <span class="n">self</span><span class="p">.</span><span class="n">mensaje</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@&quot;Haz seleccionado la opción 1&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span><span class='line'>            <span class="n">self</span><span class="p">.</span><span class="n">mensaje</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">@&quot;Haz seleccionado la opción 2&quot;</span><span class="p">;</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="k">default</span><span class="o">:</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

La variable <code>buttonIndex</code> conté els índexs per a cadascun dels botons que conté la finestra d&#8217;alerta. Així que podem fer coses diferents depenent del &#8220;cas&#8221;.

Aquest mètode, com ja hem explicat, no és del nostre delegat, simplement estem habilitats per personalitzar la resposta a un esdeveniment usant aquest mètode, però no ho vam crear nosaltres ni definim la capçalera del mètode. Per tant el compilador ens va a llançar una excepció al moment de compilar el codi i l&#8217;aplicació petará. Per evitar això, hem de fer que el nostre delegat &#8220;sigui conforme&#8221; al protocol on està definit aquest mètode (relacionat a un esdeveniment) i tots els disparats per la finestra d&#8217;alerta.
<p style="text-align: center;"><a href="http://www.thxou.com/wp-content/uploads/2012/04/grafic-delegation.png"><img class=" wp-image-2185 aligncenter" title="grafic-delegation" src="http://www.thxou.com/wp-content/uploads/2012/04/grafic-delegation.png" alt="" width="463" height="248" /></a></p>
<p style="text-align: center;"><small>Representació del patró delegate</small></p>

<h2>Que passa amb els protocols?</h2>
Els protocols són <strong>simples llistes de mètodes sense implementar</strong>. No són classes, però si hereten de classes, tampoc podem fer instàncies d&#8217;ells ni crear variables d&#8217;instància dins d&#8217;ells. Els seus mètodes són implementats en les classes que &#8220;són conformes&#8221; a aquest protocol. Un protocol delegat és aquell usat per a la delegació, i en el nostre cas anem a necessitar el protocol delegat de <code>UIAlertView</code> que implementa el mètode <code>alertView:clickedButtonAtIndex:</code>, i est és: <code>UIAlertViewDelegate</code>. Quan ocorre un esdeveniment en l&#8217;objecte, s&#8217;envia el missatge corresponent del protocol delegat.

En un <strong>protocol delegat</strong> podem trobar-nos 2 tipus de mètodes. Uns manipulen actualitzacions d&#8217;informació, com per exemple en el cas del GPS al principi, la localització serà diferent sempre que et moguis, per tant el mètode retornarà informació diferent cada vegada; I uns altres, s&#8217;envien com a respostes a entrades de l&#8217;usuari, com en el nostre cas, quan l&#8217;usuari prem un botó de la finestra d&#8217;alerta. Hi ha alguns mètodes que podrien entrar en una tercera categoria, i és el cas de <code>alertViewShouldEnableFirstOtherButton:</code>. En aquest mètode, la finestra d&#8217;alerta pregunta al delegat si ha de mostrar habilitat o deshabilitat el primer dels botons. La resposta del delegat pot ser simplement <code>YES</code> o <code>NO</code>. En el nostre cas he posat <code>NO</code>, perquè vegis el comportament que té aquest mètode.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">alertViewShouldEnableFirstOtherButton:</span><span class="p">(</span><span class="n">UIAlertView</span> <span class="o">*</span><span class="p">)</span><span class="nv">alertView</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">NO</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Ja solament ens queda fer que el nostre delegat &#8220;sigui conforme&#8221; a <code>UIAlertViewDelegate</code>. Això ho fem en la capçalera de la nostra classe <em>ViewController.h</em> a la declaració <code>@interface</code>, entre signes de major i menor.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> : <span class="nc">UIViewController</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">UIAlertViewDelegate</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">@private</span>
</span><span class='line'>    <span class="n">UILabel</span> <span class="o">*</span><span class="n">mensaje</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

He creat missatge, que és un objecte <code>UILabel</code>, per mostrar missatges depenent que botó ha estat premut.

Llest, ja hem acabat. Jo et recomano que analitzis el codi i facis canvis, molts canvis, perquè vegis com funciona la classe i el seu protocol delegat. Trobaràs enllaços a la documentació d&#8217;Apple sobre aquest tema més a baix. En aquesta mateixa aplicació d&#8217;exemple intenta afegir més mètodes de <code>UIAlertViewDelegate</code> i així saber com funcionen.

Espero haver-te ajudat a comprendre aquest tema. Qualsevol dubte o suggeriment utilitza els comentaris.

<a href="http://developer.apple.com/library/ios/#DOCUMENTATION/UIKit/Reference/UIAlertView_Class/UIAlertView/UIAlertView.html">UIAlertView</a> | <a href="http://developer.apple.com/library/ios/#DOCUMENTATION/UIKit/Reference/UIAlertViewDelegate_Protocol/UIAlertViewDelegate/UIAlertViewDelegate.html">UIAlertViewDelegate</a>
<p style="text-align: center;"><a href="http://securelink.thxou.com/?https://www.box.com/s/7f6fa46bc386d08c6100"><img class="alignnone size-full wp-image-2134" title="boton-thxou.com" src="http://www.thxou.com/wp-content/uploads/2011/11/boton-thxou.png" alt="" width="256" height="52" /></a></p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2012/10/18/ios-programant-notificacions-locals-amb-uilocalnotification/">iOS: Programant Notificacions Locals Amb UILocalNotification</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2012-10-18T13:21:05+02:00" pubdate data-updated="true">Oct 18<span>th</span>, 2012</time>
        
         | <a href="/2012/10/18/ios-programant-notificacions-locals-amb-uilocalnotification/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><img class="alignright" title="notifyme-thxou.com" src="http://www.thxou.com/wp-content/uploads/2012/01/Screen-shot-2012-01-30-at-20.05.49.png" alt="" width="310" height="264" />Aquí estem una altra vegada amb un nou tutorial. Aquesta vegada intentaré explicar-los de manera teòrica i pràctica el procés per programar una notificació local. És relativament senzill d&#8217;implementar i hi ha poques opcions que configurar.

La classe <code>UILocalNotification</code> et permet representar notificacions locals com la de la imatge (similars a les notificacions Push que treballen amb un servidor extern. No parlarem d&#8217;això ara), que la teva aplicació podria programar perquè siguin presentades als teus usuaris en una data i hora determinades. El sistema operatiu és l&#8217;encarregat de gestionar aquestes notificacions i <strong>permet programar fins a 64 notificacions per aplicació</strong>.

<code>UILocalNotification</code> adopta el protocol <code>NSCopying</code>, i una dels seus avantatges és que ens permet copiar notificacions ja programades, també modificar-les i cancel·lar-les. Tot en el quadre de notificació, excepte el color, es pot personalitzar al complet: pots definir un títol, el text de la notificació, quants botons va a tenir, un so personalitzat el qual es reprodueixi en mostrar-se, etc. Totes aquestes opcions les anem a aprendre a configurar nosaltres mateixos a continuació amb un exemple pràctic.
<h2>Portant-ho a la pràctica</h2>
He creat una altra mini-app trucada <em>notifyme</em> que et pots descarregar des del botó enorme del final d&#8217;aquest article (Molt recomanat descarregar-la i seguir el toturial amb ella). El que vas a aprendre amb aquesta app és a programar una notificació local amb configuracions personalitzades i rebre un text juntament amb la notificació per mostrar-la a l&#8217;usuari, en aquest cas, la mostrarem en un quadre de text de la pantalla principal, però també es podria mostrar com una alerta.

Obrim l&#8217;aplicació en*Xcode i en el <em>Project Navigator</em> podem veure el nostre controlador de l&#8217;aplicació: AppDelegate.h i .m, i també el controlador de la vista principal ViewController.h i .m. Obrim el ViewController.m i ens anem al mètode:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">programarNotificacion</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">UILocalNotification</span> <span class="o">*</span><span class="n">localNot</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UILocalNotification</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="n">localNot</span><span class="p">.</span><span class="n">fireDate</span> <span class="o">=</span> <span class="p">[</span><span class="n">pickerCaducidad</span> <span class="n">date</span><span class="p">];</span>
</span><span class='line'>    <span class="n">localNot</span><span class="p">.</span><span class="n">timeZone</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSTimeZone</span> <span class="n">defaultTimeZone</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">localNot</span><span class="p">.</span><span class="n">alertBody</span> <span class="o">=</span> <span class="s">@&quot;Mi primera notificación&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">localNot</span><span class="p">.</span><span class="n">alertAction</span> <span class="o">=</span> <span class="s">@&quot;Mostrar&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">localNot</span><span class="p">.</span><span class="n">soundName</span> <span class="o">=</span> <span class="n">UILocalNotificationDefaultSoundName</span><span class="p">;</span>
</span><span class='line'>    <span class="n">localNot</span><span class="p">.</span><span class="n">applicationIconBadgeNumber</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">userDict</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDictionary</span> <span class="nl">dictionaryWithObject:</span><span class="n">textoNotificacion</span><span class="p">.</span><span class="n">text</span> <span class="nl">forKey:</span><span class="n">kNotificationTextKey</span><span class="p">];</span>
</span><span class='line'>    <span class="n">localNot</span><span class="p">.</span><span class="n">userInfo</span> <span class="o">=</span> <span class="n">userDict</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[[</span><span class="n">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">scheduleLocalNotification:</span><span class="n">localNot</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">localNot</span> <span class="n">release</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Aquest mètode és la part principal de la nostra aplicació ja que és el que va a programar la notificació, així que vaig a explicar-los les parts que ho componen i la seva configuració.

Com ja sabem, per treballar amb classes cal fer-ho a través d&#8217;objectes, i aquests objectes els vam crear a través d&#8217;instàncies de classes, així que el que fem primer és crear una instància de la classe <code>UILocalNotification</code> trucada &#8221;<em>localNot</em>&#8221;. Aquesta instància va a representar aquesta notificació en la cua de notificacions del sistema operatiu. Bé, aquest objecte té les següents propietats:
<ul>
	<li><strong>fireDate:</strong> La data i hora exacta en la qual desitgem mostrar la notificació.</li>
	<li><strong>timeZone:</strong> Treballa juntament amb <code>fireDate</code> i serveix perquè la notificació es mostri adaptada per a una zona horària específica. Nosaltres usem <code>defaultTimeZone</code> que utilitza la zona horària de l&#8217;aplicació.</li>
	<li><strong>alertBody:</strong> És el cos del missatge que es mostra juntament amb la notificació.</li>
	<li><strong>alertAction:</strong> És el text del botó d&#8217;acció. En la imatge diu &#8220;Mostrar&#8221; i en prémer-ho va a obrir l&#8217;aplicació.</li>
	<li><strong>soundName:</strong> El so personalitzat que vols que es reprodueixi en mostrar-se la notificació. <code>UILocalNotificationDefaultSoundName</code> especifica el so per defecte del sistema, però podem posar el que nosaltres vulguem, sempre que duri <strong>30 segons</strong> i siguin de format <code>aiff</code>, <code>wav</code> o <code>caf</code>.</li>
	<li><strong>applicationIconBadgeNumber:</strong> Si us heu fixat, hi ha aplicacions que mostren un circulo vermell en la part superior dreta de la icona de la app. A això es refereix aquesta propietat. És un enter de tipus <code>NSInteger</code> al que podem assignar-li un nombre.</li>
	<li><strong>userInfo:</strong> Aquesta propietat és un diccionari tipus <code>NSDictionary</code>, en la qual podem guardar informació per després recuperar-la quan es mostri nostra app després de pressionar el botó d&#8217;acció.</li>
</ul>
Existeixen altres propietats més, a part de les usades en aquesta aplicació, algunes una mica menys importants però que te les explico en una línia:
<ul>
	<li><strong>repeatInterval:</strong> Serveix per reprogramar la notificació en un interval de temps específic.</li>
	<li><strong>repeatCalendar:</strong> El calendari en el qual l&#8217;aplicació es basarà per reprogramar la notificació.</li>
	<li><strong>hasAction:</strong> És un propietat de tipus <code>BOOL</code>, que especifica si es mostra o no el botó d&#8217;acció.</li>
	<li><strong>alertLaunchImage:</strong> La imatge que es mostra immediatament quan es pressiona el botó d&#8217;acció.</li>
</ul>
Aquí cal explicar una mica el camp <code>userInfo</code>. Jo he creat una constant a la qual he cridat <code>kNotificationTextKey</code> per usar-la com el text que vull que acompanyi a la notificació. L&#8217;he declarat en el AppDelegate.h i després assignat un string que és el nom amb el qual es guardarà juntament amb l&#8217;aplicació. També l&#8217;he declarat com <code>extern</code>, perquè estigui disponible anés de la classe AppDelegate. Com podeu veure, el valor d&#8217;aquesta constant és el que escrivim en el <code>UITextField</code> de la interfície gràfica (<code>textoNotificacion</code>).

Explicat això, és el moment d&#8217;enviar la notificació (el nostre objecte <code>localNot</code>) al sistema operatiu perquè la gestioni. Per a això utilitzem un mètode de la classe <code>UIApplication</code> anomenat <code>scheduleLocalNotification:localNot</code>. Aquest mètode utilitza el valor del camp <code>fireDate</code> per programar la notificació i que es mostri en una data i hora concretes. Un altre mètode que també interessa és <code>presentLocalNotificationNow:</code>, el qual mostra la notificació immediatament per pantalla.

En aquest mateix arxiu podem veure el mètode: <code>-(IBAction)prepararNotificacion:(id)sender</code>. El que va a fer és, a part d&#8217;executar el mètode d&#8217;a dalt, cancel·lar totes les notificacions programades anteriorment utilitzant el mètode de <code>UIApplication</code> anomenat <code>cancelAllLocalNotifications</code>. Si per contra, solament volem fer-ho per a una notificació específica utilitzarem <code>cancelLocalNotification:localNot</code>.
<h2>Mostrant la notificació</h2>
Val, ja hem programat  la notificació, ara ens toca rebre i manipular la informació que porta amb si la notificació quan es mostra, així podem personalitzar-la més al nostre gust. Hi ha 2 estats en els quals podria trobar-se l&#8217;aplicació en rebre la notificació: quan està visible i quan està tancada. Com ja sabem, en pressionar en el botó d&#8217;acció (o lliscar el dit quan el dispositiu està bloquejat) s&#8217;obre l&#8217;aplicació, en obrir-se, depenent d&#8217;en qual d&#8217;aquests 2 estats es troba, s&#8217;executen 2 mètodes de <code>UIApplication</code>. Aquests mètodes els podem trobar ja implementats en l&#8217;arxiu del controlador principal de l&#8217;aplicació AppDelegate.m. Si l&#8217;aplicació no està visible s&#8217;executa el mètode <code>application:didFinishLaunchingWithOptions:</code>. El següent codi és el que he afegit al predeterminat per manipular les dades de la notificació:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="c1">// Notificacions</span>
</span><span class='line'>    <span class="n">application</span><span class="p">.</span><span class="n">applicationIconBadgeNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">UILocalNotification</span> <span class="o">*</span><span class="n">notification</span> <span class="o">=</span> <span class="p">[</span><span class="n">launchOptions</span> <span class="nl">objectForKey:</span>
</span><span class='line'>                                         <span class="n">UIApplicationLaunchOptionsLocalNotificationKey</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">notification</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSString</span> <span class="o">*</span><span class="n">reminderText</span> <span class="o">=</span> <span class="p">[</span><span class="n">notification</span><span class="p">.</span><span class="n">userInfo</span>
</span><span class='line'>                                  <span class="nl">objectForKey:</span><span class="n">kNotificationTextKey</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">_viewController</span> <span class="nl">despliegaNotificacion:</span><span class="n">reminderText</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Nota que el mètode té un paràmetre anomenat <code>launchOptions</code>. Aquest paràmetre és un diccionari (<code>NSDictionary</code>) que porta amb si informació sobre el perquè que s&#8217;hagi obert l&#8217;aplicació. En aquest cas, quan un dels motius és una notificació, aquesta es guarda en una constant del sistema designada per a això: <code>UIApplicationLaunchOptionsLocalNotificationKey</code>. Si aquesta constant conté la notificació, llavors est ha estat el motiu de la seva obertura, així que guardem aquesta notificació en un punter que hem cridat &#8220;*notification&#8221;. Si us acordeu, abans guardem un text en la constant <code>kNotificationTextKey</code>, per la qual cosa ara ho recuperem en el string <code>reminderText</code>.

Si es dóna l&#8217;altre cas, en el qual l&#8217;aplicació està visible llavors s&#8217;executa un altre mètode de <code>UIApplication</code> anomenat <code>application:didReceiveLocalNotification:</code>. No es mostren alertes ni es reprodueixen sons, però si es pot tractar amb la informació que ve amb la notificació:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didReceiveLocalNotification:</span><span class="p">(</span><span class="n">UILocalNotification</span> <span class="o">*</span><span class="p">)</span><span class="nv">notification</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>	<span class="n">application</span><span class="p">.</span><span class="n">applicationIconBadgeNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>	<span class="n">NSString</span> <span class="o">*</span><span class="n">reminderText</span> <span class="o">=</span> <span class="p">[</span><span class="n">notification</span><span class="p">.</span><span class="n">userInfo</span>
</span><span class='line'>                              <span class="nl">objectForKey:</span><span class="n">kNotificationTextKey</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">_viewController</span> <span class="nl">despliegaNotificacion:</span><span class="n">reminderText</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Aquí fem similar a l&#8217;anterior mètode. Llevem el <code>badgeNumber</code> i després recuperem el text de la constant <code>kNotificationTextKey</code> en el string <code>reminderText</code>.

No obstant això, i per finalitzar, la següent línia:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="p">[</span><span class="n">_viewController</span> <span class="nl">despliegaNotificacion:</span><span class="n">reminderText</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>

Utilitza l&#8217;objecte <code>_viewController</code>, creat automàticament per Xcode en crear un nou projecte, per comunicar-se amb el controlador de la nostra vista principal (ViewController.h i .m), la classe de la qual té implementat el mètode <code>despliegaNotificacion:</code>, tot això amb la finalitat de mostrar-nos el text recuperat en <code>reminderText</code> en la pantalla principal.

Engeguin l&#8217;aplicació per veure-la en funcionament. No temes canviar el codi i provar les teves pròpies idees. Fes-ho, i si surt malament llavors aprèn dels teus errors. Si bé és cert aquest tutorial es va poder haver fet en menys paraules, he volgut detallar-ho perquè puguin comprendre realment com funciona. Si em deixo alguna cosa, o dic alguna cosa en el que m&#8217;estic equivocant, agrairia molt el vostre feedback :). Gaudeixin i comparteixin aquest article. Fins a una altra!.
<p style="text-align: center;"><a href="https://www.box.com/s/s2oi1l7m4zhyvipv7kl6"><img class="alignnone size-full wp-image-2134" title="boton-thxou.com" src="http://www.thxou.com/wp-content/uploads/2011/11/boton-thxou.png" alt="" width="256" height="52" /></a></p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2012/10/05/programant-per-ios-patro-de-disseny-mvc-al-detall/">Programant Per iOS: Patró De Disseny MVC Al Detall</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2012-10-05T15:14:14+02:00" pubdate data-updated="true">Oct 5<span>th</span>, 2012</time>
        
         | <a href="/2012/10/05/programant-per-ios-patro-de-disseny-mvc-al-detall/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content">Hola de nou readers!. He volgut canviar una mica el xip i centrar-me en el que més m&#8217;omple en aquest món de la informàtica: La programació. És per això que començo aquesta sèrie de posts dedicats a la programació per a diverses plataformes. En la qual més em vaig a centrar és en iOS per iPhone, iPod i iPad, ja que indagant una mica m&#8217;ha cridat moltíssim l&#8217;atenció, així que mantinguin-se al tant del blog que va a estar molt interessant.

Sense més que dir, comencem. Existeixen molts patrons de disseny per organitzar el codi i la forma de programar aplicacions. A la programació<strong> per iOS utilitzarem el MVC o Model View Controller (Model-Vista-Controlador)</strong>.

He volgut començar amb això perquè és un tema que, encara que a molts us ha estat fàcil d&#8217;entendre, al meu no, així que ho faré que sigui el més comprensible possible perquè no hagin de tornar a llegir sobre aquest tema en el futur.

Principalment consisteix a dividir la teva aplicació en aquestes 3 capes. Cada classe que escriguis, botó que posis en el <em>Interface Builder</em>, o tros de codi que hagis d&#8217;escriure, va a pertànyer a alguna d&#8217;aquestes 3 capes.
<p style="text-align: center;"><img class="alignnone  wp-image-2118" title="MVC" src="http://www.thxou.com/wp-content/uploads/2011/11/MVC.png" alt="MVC-thxou.com" width="430" height="360" /></p>
<strong>La Vista</strong> és tot el que pots veure de l&#8217;aplicació i amb la qual l&#8217;usuari pot interactuar, dins d&#8217;aquesta trobem els botons, labels, camps de text, etc; en general, la majoria dels objectes que són subclasses de <code>UIView</code> (També les classes predefinides per l&#8217;usuari).

<strong>El Model</strong> inclou objectes que ens permeten emmagatzemar i manipular dades. Això no té res a veure amb la interfície d&#8217;usuari i li diu a l&#8217;aplicació com dur a terme tal o com tasca, o també que característiques van a tenir certs objectes.

<strong>El Controlador</strong> és el cervell d&#8217;aquest patró de disseny. El va a fer treballar a la vista i el model en sincronització perquè puguis veure coses en la pantalla o perquè en pressionar un botó, sigui efectuada alguna acció.

El MVC s&#8217;entén millor si mirem la imatge:
<ul>
	<li>L&#8217;usuari interactua amb l&#8217;aplicació i la vista (O objecte de la vista) a través de la interfície d&#8217;usuari.</li>
	<li>La vista li envia un missatge al controlador dient-li per exemple que hem pressionat un botó i volem que això respongui a alguna acció.</li>
	<li>El controlador rep el missatge i contacta amb el model per realitzar l&#8217;acció i actualitzar la informació pertinent.</li>
	<li>El controlador recull la informació requerida per la vista però actualitzada pel model i per ultimo actualitza la vista amb els canvis que  s&#8217;han fet en el model.</li>
</ul>
Senzill veritat?. Si t&#8217;adones el model no contacta directament amb el controlador, sinó que és aquest qui manipula i interpreta les dades del model, els recull i procedeix a actualitzar la vista.

És molt necessari tenir en compte les següents regles:
<ul>
	<li>El controlador pot comunicar-se amb el Model i la Vista directament.</li>
	<li>La capa Modelo i la capa Vista no es poden comunicar entre si.</li>
	<li>La capa Vista no es comunica directament amb el controlador, però si interactuen d&#8217;alguna forma, a través d&#8217;accions com veurem una mica més endavant en aquesta entrada.</li>
	<li>El Model no es pot comunicar directament amb el seu el Controlador, però si poden comunicar-se amb altres capes Modelo d&#8217;altres MVC.</li>
	<li>Pot existir també comunicació entre diferents Controladors.</li>
</ul>
Si alteres alguna d&#8217;aquestes regles ja no existiria el patró de disseny MVC.
<h2>Aplicació pràctica</h2>
Com tot el que s&#8217;aprèn a nivell practico s&#8217;aprèn més ràpid i millor, he creat un projecte molt simple per explicar una mica aquest patró de disseny *MVC, aquesta *mini aplicació mostra per pantalla 2 textos en pressionar un botó. Pots descarregar el projecte des del botó al final d&#8217;aquesta entrada i seguir-ho juntament amb aquest tutorial.

En obrir el projecte veuràs en el panell de més a la teva esquerra (<em>Project Navigator</em>: És important que et vagis quedant amb aquests noms) la llista dels arxius que componen el teu projecte. El que salta a simple vista és una classe anomenada <strong>MVCAppDelegate.h i .m</strong> (AppDelegate.h si uses XCode 4.2 o superior). Aquesta classe és el controlador de l&#8217;aplicació i s&#8217;encarrega de carregar la vista per defecte i l&#8217;aplicació en si. Bé, si obrim el AppDelegate.h veurem això si uses XCode 4.2:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &amp;lt;UIKit/UIKit.h&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@class</span> <span class="nc">ViewController</span>;
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">AppDelegate</span> : <span class="nc">UIResponder</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">UIApplicationDelegate</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">UIWindow</span> <span class="o">*</span><span class="n">window</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="n">strong</span><span class="p">,</span> <span class="n">nonatomic</span><span class="p">)</span> <span class="n">ViewController</span> <span class="o">*</span><span class="n">viewController</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>

De moment anem a deixar de costat algunes coses d&#8217;aquest codi perquè les explicaré en entrades posteriors.

Ja podem començar a identificar objectes. <code>UIWindow </code>és una classe pertanyent al UIKit Framework i que defineix un objecte finestra (En aquest cas la variable d&#8217;instància <code>window</code>) de la interfície d&#8217;usuari (D&#8217;aquí les inicials <strong>&#8220;UI&#8221; de User Interface</strong>). Cada aplicació va a tenir en general un sol objecte d&#8217;aquests. Per això aquest objecte, a l&#8217;ésser de la interfície d&#8217;usuari, pertany a la part de la Vista del MVC.

Si tornem al <em>Project Navigator</em> veurem una classe anomenada &#8220;ViewController&#8221;. Com el seu mateix nom ho indica és un controlador, i és per a una vista específica, en aquest cas la vista principal que veuràs en arrencar l&#8217;aplicació.
[nota]
<strong>NOTA:</strong> Pel que fa als noms per als controladors, és molt recomanable que el nom inclogui al final les paraules &#8221;<strong>Controller</strong>&#8221; o &#8221;<strong>View Controller</strong>&#8221; ja que això et va a permetre organitzar millor la teva <em>Project Navigator</em> i situar més ràpid els teus fitxers per editar-los. En general (per no dir sempre) et vas a trobar amb projectes en què els controladors tenen noms com: ListasViewController o GameController. Si són projectes molt grans, vas a agrair que es nomenin els controladors d&#8217;aquesta manera, t&#8217;embolicaràs menys :). <strong></strong>
[/nota]
Obrim el fitxer de capçalera del nostre controlador: MVCViewController.h, i veurem el següent codi:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &amp;lt;UIKit/UIKit.h&amp;gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">MVCViewController</span> : <span class="nc">UIViewController</span> <span class="p">{</span>
</span><span class='line'>	<span class="n">NSMutableArray</span> <span class="o">*</span><span class="n">textos</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>	<span class="kt">IBOutlet</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">texto1</span><span class="p">;</span>
</span><span class='line'>	<span class="kt">IBOutlet</span> <span class="n">UILabel</span> <span class="o">*</span><span class="n">texto2</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nl">mostrarTextos:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">sender</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>

El Model sol utilitzar objectes de col·lecció com els <code>NSArray</code> o <code>NSDictionary</code> o els tipus com <code>NSString</code> o <code>NSNumber</code>, en la nostra aplicació podem identificar com a part del model a l&#8217;objecto textos de la classe <code>NSMutableArray</code>. També tenim 2 objectes <code>UILabel</code> que corresponen a la interfície d&#8217;usuari i formen part de la capa Vista. Els noms de les classes personalitzades per a la Vista solen acabar amb la paraula &#8221;<strong>View</strong>&#8221; com per exemple: GhaphicView, i això per la mateixa raó que per als controladors. Aquests també pertanyen a la capa Vista.

La comunicació entre la capa controlador i la capa vista és cega. Com pots veure en el codi, als <code>UILabel</code> els precedeix una macro cridada <code>IBOutlet</code>, aquesta els permet connectar-se amb el controlador per així poder enviar-li accions. Els objectes de la vista no tenen control sobre que fer sobre si, així que envien accions al controlador quan alguna cosa succeeix, per exemple quan es pressiona un botó com en el nostre cas amb el mètode: <code>mostrarTextos:sender</code>.

De vegades, la capa Vista necessita respondre a certs esdeveniments com per exemple quan un camp de text s&#8217;ha començat a editar. Com la Vista no té control sobre si mateixa, necessita del controlador perquè respongui per ella, llavors el controlador s&#8217;assigna a si mateix com a delegat (Veurem aquests conceptes més endavant) de la vista (Tot això a través de protocols) i si està preparat per respondre (Té els mètodes adequats correctament implementats), llavors respon.

Si obrim el fitxer d&#8217;implementació: MVCViewController.m, podrem veure el mètode <code>mostrarTextos:sender:</code>:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// mètode que va a mostrar els textos </span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">mostrarTextos:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// inicialitzem en un array els 2 textos a mostrar</span>
</span><span class='line'>    <span class="n">textos</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableArray</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithObjects:</span><span class="s">@&quot;Texto de ejemplo para MVC&quot;</span><span class="p">,</span> <span class="s">@&quot;MVC mola cuando lo entiendes&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">txt1</span> <span class="o">=</span> <span class="p">[</span><span class="n">textos</span> <span class="nl">objectAtIndex:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">txt2</span> <span class="o">=</span> <span class="p">[</span><span class="n">textos</span> <span class="nl">objectAtIndex:</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">texto1</span> <span class="nl">setText:</span><span class="n">txt1</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">texto2</span> <span class="nl">setText:</span><span class="n">txt2</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

En pressionar-se el botó s&#8217;executa l&#8217;acció <code>mostrarTextos:sender:</code> (En realitat s&#8217;envia un missatge, que és un concepte nou en Objective-C). En aquesta acció el controlador pren les dades que té disponibles la capa Model, en aquest cas la informació carregada en l&#8217;objecte <code>NSMutableArray</code> anomenat textos i llavors assigna els valors recollits en variables temporals i les retorna a la vista perquè els textos siguin mostrats. L&#8217;objecte <code>UILabel</code> sap mostrar text, però NO SAP que text mostrar, d&#8217;igual manera el <code>NSMutableArray</code> sap emmagatzemar dades, però NO SAP que dades ha d&#8217;emmagatzemar, és per això que usem el controlador per a això.

Recorda respectar les regles del MVC i així les teves aplicacions estaran ben estructurades, de manera que quan comparteixis el teu codi, aquest es pugui entendre millor.

Espero haver-los ajudat. Si m&#8217;ha faltat alguna cosa, solament comenteu-ho. Pots descarregar els arxius del tutorial pressionant el botó d&#8217;a baix.
<p style="text-align: center;"><a href="http://securelink.thxou.com/?https://www.box.com/s/26lmhu53g5hnzubajfuh"><img class="alignnone size-full wp-image-2134" title="boton-thxou.com" src="http://www.thxou.com/wp-content/uploads/2011/11/boton-thxou.png" alt="" width="256" height="52" /></a></p></div>
  
  


    </article>
  
  
    <article>
      
  <header>
  
    
      <h1 class="entry-title"><a href="/2012/09/20/trabajando-con-el-social-framework-de-ios-6-publicar-en-twitter-y-obtener-el-timeline/">Treballant Amb El Social Framework De iOS 6: SLRequest, Publicar en Twitter I Obtenir El Timeline</a></h1>
      
      
    
      <p class="meta">
        








  


<time datetime="2012-09-20T16:57:56+02:00" pubdate data-updated="true">Sep 20<span>th</span>, 2012</time>
        
         | <a href="/2012/09/20/trabajando-con-el-social-framework-de-ios-6-publicar-en-twitter-y-obtener-el-timeline/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p style="text-align: center;"><a href="http://www.thxou.com/wp-content/uploads/2012/09/Screen-Shot-2012-09-20-at-14.23.29.png"><img class="size-full wp-image-2359" title="totweet-thxou.com" src="http://www.thxou.com/wp-content/uploads/2012/09/Screen-Shot-2012-09-20-at-14.23.29.png" alt="" width="319" height="479" /></a></p>
Seguint amb els tutorials sobre iOS 6, avui ens toca Twittear (o com s&#8217;escrigui) i mostrar el nostre timeline de Twitter en una aplicació.

Abans quan volíem comunicar-nos amb Twitter i obtenir dades i actualitzar-los calia fer una connexió a través de OAuth amb uns tokens i secret-keys, això normalment es podia digerir millor usant algun framework o classe externa que servia d&#8217;interfície de connexió entre el client i el servei. Des de l&#8217;arribada del framework de Twitter i la integració amb iOS 5 les coses es van posar extraordinàriament més fàcils, això ens va permetre l&#8217;intercanvi de dades amb Twitter en tan sol pocs passos.

En el Social *Framework tenim una classe anomenada <code>SLRequest</code>, molt similar a <code>TWRequest</code> del framework de twitter. Aquesta classe encapsula les propietats d&#8217;una petició HTTP en mètodes fàcils d&#8217;utilitzar, amb els quals enviem peticions a Twitter per poder obtenir i actualitzar dades dels nostres comptes configurats en el dispositiu.

Bàsicament enviem una petició HTTP amb uns paràmetres que configuren el que volem dur a terme en el servei, si Twitter diu que no hi ha problema, rebem una resposta amb unes dades que hem de manipular i mostrar a l&#8217;usuari, en cas contrari rebem una informació d&#8217;error.
<h2>Autenticant la petició</h2>
Com els deia paràgrafs enrere, abans calia usar tokens i secret-keys per autenticar-nos en Twitter i així poder validar les nostres peticions. Amb el Social Framework fem el mateix però de forma automàtica, més transparent a l&#8217;usuari, i en certa forma al desenvolupador, ja que en cap moment hem de manipular tokens.

Des de iOS 5 tenim el Accounts Framework, el qual proveeix un sistema centralitzat de comptes d&#8217;usuari. A través de l&#8217;es emmagatzemen tots els comptes de Twitter (I d&#8217;altres serveis) configurades en el dispositiu: informació d&#8217;usuari i contrasenya i altra, això ens permet saltar-nos aquesta típica finestra d&#8217;inici de sessió sense haver de preocupar-nos per proveir un sistema per emmagatzemar nosaltres mateixos les credencials.

Hi ha poques coses que podem fer sense autenticació d&#8217;usuari, i obtenir el timeline és una d&#8217;elles. No obstant això, per fer que això funcioni amb qualsevol compte, centralitzarem totes les peticions en els comptes obtinguts de la base de dades de comptes del dispositiu. Comencem:

El primer serà importar els frameworks:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#import &amp;lt;Accounts/Accounts.h&amp;gt;</span>
</span><span class='line'><span class="cp">#import &amp;lt;Social/Social.h&amp;gt;</span>
</span></code></pre></td></tr></table></div></figure>

Després fem la màgia d&#8217;obtenir els comptes del dispositiu amb el Accounts Framework:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">ACAccountStore</span><span class="err"> </span><span class="o">*</span><span class="n">accountStore</span><span class="err"> </span><span class="o">=</span> <span class="p">[[</span><span class="n">ACAccountStore</span><span class="err"> </span><span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creguem un objecte accountType especificant que solament volem obtenir els comptes de Twitter</span>
</span><span class='line'><span class="n">ACAccountType</span><span class="err"> </span><span class="o">*</span><span class="n">accountType</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">accountStore</span><span class="err"> </span><span class="nl">accountTypeWithAccountTypeIdentifier:</span><span class="n">ACAccountTypeIdentifierTwitter</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">accountStore</span><span class="err"> </span><span class="nl">requestAccessToAccountsWithType:</span><span class="n">accountType</span>
</span><span class='line'>                                      <span class="nl">options:</span><span class="nb">nil</span>
</span><span class='line'>                                   <span class="nl">completion:</span><span class="o">^</span><span class="p">(</span><span class="kt">BOOL</span><span class="err"> </span><span class="n">granted</span><span class="p">,</span> <span class="n">NSError</span><span class="err"> </span><span class="o">*</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="err"> </span><span class="p">(</span><span class="n">granted</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// guardem els comptes de twitter en un array </span>
</span><span class='line'>        <span class="n">NSArray</span><span class="err"> </span><span class="o">*</span><span class="n">accountsArray</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">accountStore</span><span class="err"> </span><span class="nl">accountsWithAccountType:</span><span class="n">accountType</span><span class="p">];</span>
</span><span class='line'>        <span class="c1">// armem la petició aquí</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span><span class="err"> </span><span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error no se pudo acceder a las cuentas: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="n">localizedDescription</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>

El que fem aquí és crear una instància de la base de dades de comptes. Després a través de la classe <code>ACAccountType</code> diem que solament volem els comptes de Twitter, passant-li la constant  <code>ACAccountTypeIdentifierTwitter</code> com a argument en la inicialització. Tot seguit demanem accés a les comptes amb el mètode <code>requestAccessToAccountsWithType:options:completion:</code>. Aquest mètode té com a argument el bloc <code>completion:</code>, el qual és un handler (Un objecte &#8220;manipulador&#8221; per així dir-ho) en els paràmetres del qual és retornada la resposta del mètode. Si tot va bé emmagatzemem tots els comptes obtinguts en el array <code>accountsArray</code> o vam mostrar un error en cas contrari. Simple.

Recorda aquesta dinàmica d&#8217;executar un mètode i rebre una resposta per ser manipulada en un bloc, perquè ho veuràs molt sovint des d&#8217;ara.
<h2>Construint la petició per obtenir el timeline</h2>
Amb el Social Framework és definitivament molt més fàcil construir una petició HTTP. Sabem que està composta per:
<ol>
	<li>Una URL que identifica l&#8217;operació que volem realitzar en el servei.</li>
	<li>Un mètode de petició, que pot ser GET, POST o DELETE.</li>
	<li>I uns paràmetres de configuració.</li>
</ol>
El mètode <code>requestForServiceType:requestMethod:URL:parameters:</code> passa totes aquestes dades com els seus arguments i això ens permet crear la petició en tan sol una línia de codi si així ho desitgem.

El que nosaltres volem és obtenir el timeline, per tant necessitem anar a la <a title="Versión 1.1 de la API de Twitter" href="http://securelink.thxou.com/?https://dev.twitter.com/docs/api/1.1" target="_blank">documentació oficial</a> per veure el que hem d&#8217;usar. En entrar en l&#8217;enllaç i seleccionar l&#8217;operació de la qual volem veure els detalls (en aquest cas és: <code>GET</code> <code>statuses/home_timeline</code>), veurem en l&#8217;apartat <strong>Resourse Information</strong> certa informació molt important:
<p style="text-align: center;"><img class="size-full wp-image-2326 aligncenter" title="twitter-thxou.com" src="http://www.thxou.com/wp-content/uploads/2012/09/Screen-Shot-2012-09-11-at-17.08.28.png" alt="" width="249" height="392" /></p>
Tenim el mètode de la petició (GET), el format de resposta (JSON) i l&#8217;objecte de resposta (Tweets). Després està l&#8217;apartat <strong>Resource URL</strong> que és la URL que li passarem i l&#8217;apartat <strong>Parameters</strong>, que conté els paràmetres per configurar-la. Usant aquesta informació construïm la petició:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// guardem el compte</span>
</span><span class='line'><span class="n">ACAccount</span><span class="err"> </span><span class="o">*</span><span class="n">twitterAccount</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">accountsArray</span><span class="err"> </span><span class="nl">objectAtIndex:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">cuenta</span> <span class="o">=</span> <span class="n">twitterAccount</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creguem la petició</span>
</span><span class='line'><span class="n">NSURL</span><span class="err"> </span><span class="o">*</span><span class="n">url</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span><span class="err"> </span><span class="nl">URLWithString:</span><span class="s">@&quot;https://api.twitter.com/1.1/statuses/home_timeline.json&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="n">NSDictionary</span><span class="err"> </span><span class="o">*</span><span class="n">parametros</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">NSDictionary</span><span class="err"> </span><span class="nl">dictionaryWithObjectsAndKeys:</span>
</span><span class='line'>                                <span class="s">@&quot;25&quot;</span><span class="p">,</span> <span class="s">@&quot;count&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="n">SLRequest</span> <span class="o">*</span><span class="n">request</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">SLRequest</span> <span class="nl">requestForServiceType:</span><span class="n">SLServiceTypeTwitter</span>
</span><span class='line'>                                        <span class="nl">requestMethod:</span><span class="n">SLRequestMethodGET</span>
</span><span class='line'>                                                  <span class="nl">URL:</span><span class="n">url</span>
</span><span class='line'>                                           <span class="nl">parameters:</span><span class="n">parametros</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// associem el compte a la petició</span>
</span><span class='line'><span class="p">[</span><span class="n">request</span><span class="err"> </span><span class="nl">setAccount:</span><span class="n">twitterAccount</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>

Per motius de brevetat tan solament utilitzarem el primer compte de les quals hi ha en el array.

He creat la propietat <code>cuenta</code> de tipus <code>ACAccount</code>, en ella emmagatzemem aquest compte per posteriorment poder enviar-la al controlador des del qual publicarem un missatge d&#8217;estat (el que és un Tweet) al nostre timeline, això més endavant.

Com poden veure tenim un diccionari per als paràmetres. El meu solament té una key: <code>count</code>, aquesta ens permet limitar la quantitat de tweets que ens va a retornar el timeline que per defecte és 20, però jo l&#8217;he posat a 25. En la documentació de la API estan tots els paràmetres que podem usar per configurar la petició.

El següent és assignar-li a la propietat <code>account</code> de la nostra petició, el compte que hem triat del array i amb la qual volem treballar per mostrar el timeline i altres coses.
<h2>Enviant la petició i manipulant els resultats</h2>
Una vegada construïda la petició procedim a enviar-la. Per a això usem el mètode <code>performRequestWithHandler:</code> que envia la petició i recull els resultats en el seu únic argument. Est és al seu torn un bloc, el qual és executat una vegada estan disponibles les dades de la resposta.

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// realitzem la petició especificant un mètode per manipular la resposta</span>
</span><span class='line'><span class="p">[</span><span class="n">request</span><span class="err"> </span><span class="nl">performRequestWithHandler:</span><span class="o">^</span><span class="p">(</span><span class="n">NSData</span><span class="err"> </span><span class="o">*</span><span class="n">responseData</span><span class="p">,</span> <span class="n">NSHTTPURLResponse</span><span class="err"> </span><span class="o">*</span><span class="n">urlResponse</span><span class="p">,</span> <span class="n">NSError</span><span class="err"> </span><span class="o">*</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="err"> </span><span class="p">(</span><span class="n">responseData</span><span class="err"> </span><span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">tweets</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span><span class="err"> </span><span class="nl">JSONObjectWithData:</span><span class="n">responseData</span>
</span><span class='line'>                                                      <span class="nl">options:</span><span class="n">kNilOptions</span>
</span><span class='line'>                                                        <span class="nl">error:</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>

Aquest bloc té 3 paràmetres, el més important és <code>responseData</code>, perquè és el que va a contenir els tweets. Aquests tweets estan en format JSON com vam veure abans, per tant necessitem parsearlos i així passar-los a un format manipulable en Objective-C. Per fer això existeix la classe <code>NSJSONSerialization</code>, que agafa les dades en <code>NSData</code> (en aquest cas <code>responseData</code>), els parsea i retorna. Aquestes dades retornades els emmagatzemem en el array <code>tweets</code>, que a continuació usarem per mostrar-los a l&#8217;usuari.

[tip]Pots aprendre més sobre com parsear dades en format JSON i la classe <code>NSJSONSerialization</code> en el nostre pràctic tutorial sobre el tema fent <a href="http://www.thxou.com/2012/09/11/parsear-y-crear-ficheros-en-formato-json-en-ios/"><strong>clic aquí</strong></a>.[/tip]
<h2>Mostrant els resultats</h2>
Bé, ja tenim fet gairebé tot el treball, ara solament ens queda mostrar els resultats, i para això tenim l&#8217;objecte <code>tweetsTableView</code>. A causa que ja tenim tots els Tweets en un array, és relativament senzill mostrar-los en el tableView, per això anem directament a implementar els mètodes convenients:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">numberOfSectionsInTableView:</span><span class="p">(</span><span class="n">UITableView</span><span class="err"> </span><span class="o">*</span><span class="p">)</span><span class="nv">tableView</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span><span class="err"> </span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">tableView:</span><span class="p">(</span><span class="n">UITableView</span><span class="err"> </span><span class="o">*</span><span class="p">)</span><span class="nv">tableView</span><span class="err"> </span><span class="nl">numberOfRowsInSection:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="n">section</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span><span class="err"> </span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tweets</span> <span class="n">count</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="n">UITableViewCell</span><span class="err"> </span><span class="o">*</span><span class="p">)</span><span class="nl">tableView:</span><span class="p">(</span><span class="n">UITableView</span><span class="err"> </span><span class="o">*</span><span class="p">)</span><span class="n">tableView</span><span class="err"> </span><span class="nl">cellForRowAtIndexPath:</span><span class="p">(</span><span class="n">NSIndexPath</span><span class="err"> </span><span class="o">*</span><span class="p">)</span><span class="n">indexPath</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span><span class="err"> </span><span class="n">NSString</span><span class="err"> </span><span class="o">*</span><span class="n">CellIdentifier</span><span class="err"> </span><span class="o">=</span> <span class="s">@&quot;Cell&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="n">UITableViewCell</span><span class="err"> </span><span class="o">*</span><span class="n">cell</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">tableView</span><span class="err"> </span><span class="nl">dequeueReusableCellWithIdentifier:</span><span class="n">CellIdentifier</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span><span class="err"> </span><span class="p">(</span><span class="n">cell</span><span class="err"> </span><span class="o">==</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">cell</span><span class="err"> </span><span class="o">=</span> <span class="p">[[[</span><span class="n">UITableViewCell</span><span class="err"> </span><span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithStyle:</span><span class="n">UITableViewCellStyleSubtitle</span><span class="err"> </span><span class="nl">reuseIdentifier:</span><span class="n">CellIdentifier</span><span class="p">]</span> <span class="n">autorelease</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSDictionary</span><span class="err"> </span><span class="o">*</span><span class="n">tweet</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tweets</span> <span class="nl">objectAtIndex:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">tweet</span><span class="err"> </span><span class="nl">objectForKey:</span><span class="s">@&quot;text&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">detailTextLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="p">[[</span><span class="n">tweet</span><span class="err"> </span><span class="nl">objectForKey:</span><span class="s">@&quot;user&quot;</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;screen_name&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// carreguem les imatges dels quals envien el tweet, de forma asíncrona</span>
</span><span class='line'>    <span class="n">dispatch_queue_t</span> <span class="n">queue</span><span class="err"> </span><span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">&quot;com.thxou.totweet&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">dispatch_queue_t</span> <span class="n">main</span> <span class="o">=</span> <span class="n">dispatch_get_main_queue</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="n">NSURL</span><span class="err"> </span><span class="o">*</span><span class="n">imageURL</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span><span class="err"> </span><span class="nl">URLWithString:</span><span class="p">[[</span><span class="n">tweet</span><span class="err"> </span><span class="nl">objectForKey:</span><span class="s">@&quot;user&quot;</span><span class="p">]</span> <span class="nl">objectForKey:</span><span class="s">@&quot;profile_image_url&quot;</span><span class="p">]];</span>
</span><span class='line'>        <span class="n">NSData</span> <span class="o">*</span><span class="n">imageData</span><span class="err"> </span><span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="nl">dataWithContentsOfURL:</span><span class="n">imageURL</span><span class="p">];</span>
</span><span class='line'>        <span class="n">dispatch_async</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>            <span class="n">cell</span><span class="p">.</span><span class="n">imageView</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span><span class="err"> </span><span class="nl">imageWithData:</span><span class="n">imageData</span><span class="p">];</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="n">dispatch_release</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">cell</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Aquí hi ha algunes línies que els sonaran a xinès, no obstant això explicaré una mica per damunt que està succeint.

Al parsearse les dades aquests són emmagatzemats en el array <code>tweets</code>, però els tweets dins del, són emmagatzemats en forma de diccionaris, fàcilment recuperables usant la classe <code>NSDictionary</code>. Llavors recuperem cada camp d&#8217;aquest array en un diccionari que jo he anomenat <code>tweet</code> per fer-ho més identificable (en realitat això és el que representa). Com ja saben, accedim als valors d&#8217;un diccionari a través de keys, però quines són aquestes keys?, ens anem a la <a href="https://dev.twitter.com/docs/platform-objects/tweets">documentació oficial</a> i ho mirem allí. El que fem és simplement mostrar el text del tweet com a títol i el nom &#8220;del que tweetea&#8221; com subtitulo en cada cel·la.

Per mostrar la imatge el que fem és usar el <strong>GCD</strong> (Grand Central Dispatch) d&#8217;Apple. A grans trets explicar-los que la descàrrega de dades de la xarxa sempre deuria ser de forma asíncrona, això és perquè és un procés que triga una mica a dur-se a terme i per tant no pot fer-se en el mateix thread (fil) ja que podem bloquejar-ho, i això deixaria inutilitzable la interfície d&#8217;usuari fins que es completi el procés, cosa que pel bé dels nostres usuaris, no volem. Doncs aquest problema ho soluciona el <strong>GCD</strong>, fent que certs mètodes s&#8217;executin de forma asíncrona (en un altre fil o thread), d&#8217;aquesta forma evitem bloquejar la interfície d&#8217;usuari.
<h2>Enviant un tweet</h2>
Doncs fer això és una mica més del mateix. Jo he creat un nou controlador per fer això anomenat <code>EnviarTweetViewController</code>, el qual es mostra en una finestra modal i té un TextView i dos botons: un per enviar el tweet i un altre per cancel·lar l&#8217;operació.

El d&#8217;enviar el tweet executa el mètode <code>enviarTweet:</code>:

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">enviarTweet:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// comprovem si el camp per escriure el tweet no està buit</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tweet</span><span class="p">.</span><span class="n">text</span> <span class="nl">isEqualToString:</span><span class="s">@&quot;&quot;</span><span class="p">])</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;https://api.twitter.com/1.1/statuses/update.json&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">parametros</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDictionary</span> <span class="nl">dictionaryWithObjectsAndKeys:</span>
</span><span class='line'>                                    <span class="n">self</span><span class="p">.</span><span class="n">tweet</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="s">@&quot;status&quot;</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">SLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">SLRequest</span> <span class="nl">requestForServiceType:</span><span class="n">SLServiceTypeTwitter</span>
</span><span class='line'>                                                <span class="nl">requestMethod:</span><span class="n">SLRequestMethodPOST</span>
</span><span class='line'>                                                          <span class="nl">URL:</span><span class="n">url</span>
</span><span class='line'>                                                   <span class="nl">parameters:</span><span class="n">parametros</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// assignem el compte que usarem per publicar el tweet</span>
</span><span class='line'>        <span class="p">[</span><span class="n">request</span> <span class="nl">setAccount:</span><span class="n">self</span><span class="p">.</span><span class="n">cuenta</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>         <span class="p">[</span><span class="n">request</span> <span class="nl">performRequestWithHandler:</span><span class="o">^</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="n">responseData</span><span class="p">,</span> <span class="n">NSHTTPURLResponse</span> <span class="o">*</span><span class="n">urlResponse</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>             <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">resultado</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">JSONObjectWithData:</span><span class="n">responseData</span>
</span><span class='line'>                                                                       <span class="nl">options:</span><span class="n">kNilOptions</span>
</span><span class='line'>                                                                         <span class="nl">error:</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>         <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="nl">cancelar:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Com podeu observar es fa exactament el mateix. Tan solament canvien els paràmetres, la URL i el mètode de la petició, i tot això el podem trobar en la documentació oficial.

A diferència de l&#8217;anterior, aquí no accedim a tots els comptes del dispositiu, sinó que simplement passem a aquest controlador el compte que hem obtingut abans, així ens assegurem que el compte que està seleccionada és des de la qual s&#8217;envia el tweet i sobre la qual es fan les operacions sol·licitades. No hi ha misteri.
<h2>Conclusió</h2>
El procediment per dur a terme totes aquestes accions en Twitter porten la mateixa estructura. Tan solament varien els paràmetres, la URL i el mètode de la petició. Pel que, si volem fer qualsevol cosa,  hem d&#8217;anar a la documentació i mirar el que necessitem. Després reemplaçar les dades que hem vist abans amb els nous, enviar la petició i mostrar a l&#8217;usuari les dades obtingudes. Així de fàcil és treballar amb el Social Framework.

Ara pots passar-te per la <a href="http://securelink.thxou.com/?https://developer.apple.com/library/ios/documentation/Social/Reference/SLRequest_Class/Reference/Reference.html#//apple_ref/doc/uid/TP40012234">documentació d&#8217;Apple</a> sobre aquest tema i també visitar el nostre tutorial sobre com parsear i manipular fitxers JSON de forma nativa i així estendre una mica més els teus coneixements.
<p style="text-align: center;"><a href="http://securelink.thxou.com/?https://www.box.com/s/c0bb4xgyatv10t5nhvll"><img class="alignnone size-full wp-image-2134" title="boton-thxou.com" src="http://www.thxou.com/wp-content/uploads/2011/11/boton-thxou.png" alt="" width="256" height="52" /></a></p></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/11/12/migracion-sencilla-de-modelos-en-core-data/">Migración sencilla de modelos en Core Data</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/25/disponible-la-segunda-beta-de-ios-7-para-desarrolladores/">Disponible la segunda beta de iOS 7 para desarrolladores</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/18/un-vistazo-al-nuevo-ios-7/">Un vistazo al nuevo iOS 7</a>
      </li>
    
      <li class="post">
        <a href="/2013/03/18/literales-en-objective-c/">Literales en Objective-C</a>
      </li>
    
      <li class="post">
        <a href="/2013/02/21/nsnotificationcenter-y-las-notificaciones/">NSNotificationCenter y las notificaciones</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/thxou">@thxou</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'thxou',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  Luis Cardenas <br/>
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> + <a href="https://github.com/ioveracker/mnml">mnml</a>.
	  
  </span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'thxou';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
